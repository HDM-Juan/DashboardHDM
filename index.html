<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital de M√≥vil - Quantum Management System</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PapaParse para leer Google Sheets -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <!-- Fuentes Corporativas -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@100..900&family=Orbitron:wght@400..900&display=swap');
        
        :root {
            --glass-bg: rgba(13, 17, 23, 0.85);
            --glass-border: rgba(255, 255, 255, 0.08);
            --metallic-dark: #0f172a;
            --metallic-light: #334155;
            --corporate-red: #dc2626; 
            --corporate-red-glow: rgba(220, 38, 38, 0.5);
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
        }

        body { 
            font-family: 'Montserrat', sans-serif;
            background-color: #020617;
            color: var(--text-main);
            background-image: 
                linear-gradient(rgba(2, 6, 23, 0.9), rgba(2, 6, 23, 0.95)),
                url('https://www.transparenttextures.com/patterns/carbon-fibre.png');
            background-attachment: fixed;
        }

        .font-cyber { font-family: 'Orbitron', sans-serif; }

        /* Efecto Glassmorphism Avanzado */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 0.75rem;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }

        /* Encabezados Met√°licos */
        .metallic-header {
            background: linear-gradient(180deg, var(--metallic-light) 0%, var(--metallic-dark) 100%);
            border-bottom: 3px solid var(--corporate-red);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }

        /* Animaciones de Colapso */
        .collapsible-content {
            transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.5s ease;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        .collapsible-content.expanded {
            max-height: 20000px;
            opacity: 1;
        }

        /* Tablas de Alta Densidad */
        table { border-collapse: separate; border-spacing: 0; width: 100%; }
        thead th { 
            background: rgba(30, 41, 59, 0.9);
            color: #cbd5e1;
            text-transform: uppercase;
            font-size: 0.65rem;
            font-weight: 700;
            letter-spacing: 0.05em;
            padding: 10px;
            border-bottom: 2px solid var(--metallic-light);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        tbody tr { background: rgba(255, 255, 255, 0.01); transition: all 0.2s; }
        tbody tr:hover { background: rgba(220, 38, 38, 0.15); transform: translateX(2px); }
        td { 
            padding: 8px 10px; 
            border-bottom: 1px solid rgba(255,255,255,0.03); 
            font-size: 0.7rem;
            white-space: nowrap;
        }

        /* Utilidades */
        .kpi-value { font-family: 'Orbitron', sans-serif; letter-spacing: -0.5px; }
        .text-glow { text-shadow: 0 0 10px var(--corporate-red-glow); }
        
        /* Botones personalizados */
        .btn-repo {
            background: #1f2937;
            border: 1px solid #374151;
            display: flex; align-items: center; gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.2s;
        }
        .btn-repo:hover { background: #374151; border-color: var(--corporate-red); color: white; }

        /* Loader */
        .loader-bar {
            height: 2px;
            width: 100%;
            background: linear-gradient(90deg, transparent, var(--corporate-red), transparent);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body class="min-h-screen">

    <!-- Navbar Corporativo -->
    <nav class="metallic-header sticky top-0 z-50 px-4 py-3 flex flex-wrap justify-between items-center">
        <div class="flex items-center space-x-4">
            <div class="relative group">
                <img src="https://i.imgur.com/6R6fPFf.gif" alt="Logo" class="w-12 h-12 rounded-full border-2 border-slate-500 shadow-lg group-hover:border-red-500 transition-colors">
                <div class="absolute inset-0 rounded-full bg-red-500/20 blur-md opacity-0 group-hover:opacity-100 transition-opacity"></div>
            </div>
            <div>
                <h1 class="text-xl font-black font-cyber text-white leading-none tracking-tight">
                    HOSPITAL <span class="text-red-500 text-glow">DE</span> M√ìVIL
                </h1>
                <p class="text-[0.6rem] text-slate-400 uppercase tracking-[0.2em] font-bold mt-1">Quantum Management System v3.0</p>
            </div>
        </div>
        
        <div class="flex items-center gap-3 mt-2 sm:mt-0">
            <!-- Link al Repositorio (Placeholder) -->
            <a href="https://github.com/tu-usuario/hospital-movil-dashboard" target="_blank" class="btn-repo group">
                <svg class="w-4 h-4 text-slate-400 group-hover:text-white" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"/></svg>
                <span>GitHub Repo</span>
            </a>
            <div class="h-6 w-px bg-slate-700"></div>
            <button onclick="expandAll()" class="btn-repo">Expandir</button>
            <button onclick="collapseAll()" class="btn-repo">Contraer</button>
            <button onclick="window.location.reload()" class="bg-red-700 hover:bg-red-600 text-white px-3 py-1 rounded text-xs uppercase font-bold shadow-lg shadow-red-900/50 transition-all border border-red-500">Sincronizar</button>
        </div>
    </nav>

    <div id="loading-bar" class="loader-bar fixed top-[60px] left-0 z-40 opacity-0 transition-opacity"></div>

    <main class="p-4 space-y-6 max-w-[1800px] mx-auto pb-20">

        <!-- 1. VENTAS / FINANZAS (Verde) -->
        <section class="glass border-l-4 border-emerald-500 overflow-hidden relative group">
            <div id="bg-ventas" class="absolute inset-0 opacity-[0.08] bg-cover bg-center pointer-events-none grayscale group-hover:grayscale-0 transition-all duration-1000"></div>
            
            <div class="p-5 cursor-pointer hover:bg-white/5 transition-colors flex justify-between items-center" onclick="toggleSection('ventas')">
                <div class="flex items-center gap-4">
                    <div class="bg-emerald-900/30 p-2 rounded-lg border border-emerald-500/30">
                        <span class="text-2xl">üìó</span>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-emerald-400 font-cyber tracking-wide">VENTAS Y UTILIDAD</h2>
                        <p class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Flujo de Ingresos vs Egresos Relacionados</p>
                    </div>
                </div>
                <div class="flex items-center gap-6">
                    <div class="text-right hidden md:block">
                        <p class="text-[9px] text-gray-500 uppercase font-bold">Total Ingreso (Venta Mes)</p>
                        <p id="kpi-ventas-total" class="text-emerald-400 font-bold kpi-value text-xl">$0.00</p>
                    </div>
                    <div class="text-right hidden md:block border-l border-white/10 pl-4">
                        <p class="text-[9px] text-gray-500 uppercase font-bold">Utilidad Bruta Calc.</p>
                        <p id="kpi-ventas-utilidad" class="text-white font-bold kpi-value text-xl">$0.00</p>
                    </div>
                    <span id="icon-ventas" class="text-gray-500 transform -rotate-90 transition-transform duration-300">‚ñº</span>
                </div>
            </div>

            <div id="content-ventas" class="collapsible-content border-t border-white/5">
                <div class="p-4 grid grid-cols-1 md:grid-cols-4 gap-4 bg-slate-900/40 backdrop-blur-sm">
                    <div class="space-y-1">
                        <label class="text-[9px] text-emerald-500 font-bold uppercase tracking-wider">Filtro: Validez‚úÖ</label>
                        <select id="filter-ventas-validez" class="w-full bg-slate-800 text-xs border border-slate-600 rounded p-1.5 text-gray-300 focus:border-emerald-500 focus:ring-0 outline-none">
                            <option value="ALL">Todos los Estados</option>
                            <option value="V√°lido" selected>V√°lido</option>
                            <option value="Cancelado">Cancelado</option>
                        </select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[9px] text-emerald-500 font-bold uppercase tracking-wider">Filtro: Con Servicio</label>
                        <select class="w-full bg-slate-800 text-xs border border-slate-600 rounded p-1.5 text-gray-300 focus:border-emerald-500 focus:ring-0 outline-none">
                            <option>Todos</option>
                            <option>S√≠</option>
                        </select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[9px] text-emerald-500 font-bold uppercase tracking-wider">Costo Fijo Mensual ($)</label>
                        <input type="number" id="fixed-costs-input" value="10000" class="w-full bg-slate-800 text-xs border border-slate-600 rounded p-1.5 text-gray-300 focus:border-emerald-500 focus:ring-0 outline-none font-mono">
                    </div>
                    <div class="flex items-end">
                        <button onclick="window.updateDashboard()" class="w-full bg-gradient-to-r from-emerald-900 to-emerald-800 hover:from-emerald-800 hover:to-emerald-700 text-white border border-emerald-500/30 text-xs py-1.5 rounded uppercase font-bold tracking-wider shadow-lg transition-all">Actualizar M√©tricas</button>
                    </div>

                    <!-- Per√≠odo -->
                    <div class="space-y-1">
                        <label class="text-[9px] text-emerald-500 font-bold uppercase tracking-wider">Per√≠odo a Analizar</label>
                        <select id="filter-ventas-periodo" class="w-full bg-slate-800 text-xs border border-slate-600 rounded p-1.5 text-gray-300 focus:border-emerald-500 focus:ring-0 outline-none">
                            <option value="este-mes" selected>Este Mes</option>
                            <option value="elegir-mes">Elegir Mes...</option>
                            <option value="este-bimestre">Este Bimestre</option>
                            <option value="este-trimestre">Este Trimestre</option>
                            <option value="este-semestre">Este Semestre</option>
                            <option value="este-a√±o">Este A√±o</option>
                        </select>
                    </div>

                    <!-- Agregaci√≥n -->
                    <div class="space-y-1">
                        <label class="text-[9px] text-emerald-500 font-bold uppercase tracking-wider">Agregaci√≥n</label>
                        <select id="filter-ventas-agregacion" class="w-full bg-slate-800 text-xs border border-slate-600 rounded p-1.5 text-gray-300 focus:border-emerald-500 focus:ring-0 outline-none">
                            <option value="folio" selected>Por Folio</option>
                            <option value="dia">Por D√≠a</option>
                            <option value="semana">Por Semana</option>
                            <option value="mes">Por Mes</option>
                        </select>
                    </div>

                    <!-- Comparaci√≥n (m√∫ltiple) -->
                    <div class="space-y-1 md:col-span-2">
                        <label class="text-[9px] text-emerald-500 font-bold uppercase tracking-wider">Comparar con</label>
                        <div class="flex flex-wrap gap-2 text-[10px]">
                            <label class="flex items-center gap-1 text-gray-300">
                                <input type="checkbox" id="comp-ninguno" checked class="accent-emerald-500"> Sin Comparar
                            </label>
                            <label class="flex items-center gap-1 text-gray-300">
                                <input type="checkbox" id="comp-anterior" class="accent-emerald-500"> Per√≠odo Anterior
                            </label>
                            <label class="flex items-center gap-1 text-gray-300">
                                <input type="checkbox" id="comp-segundo" class="accent-emerald-500"> 2do Per√≠odo Anterior
                            </label>
                            <label class="flex items-center gap-1 text-gray-300">
                                <input type="checkbox" id="comp-a√±o-anterior" class="accent-emerald-500"> Mismo Per√≠odo A√±o Anterior
                            </label>
                        </div>
                    </div>

                    <!-- M√©tricas -->
                    <div class="space-y-1 col-span-full">
                        <label class="text-[9px] text-emerald-500 font-bold uppercase tracking-wider">M√©tricas a Mostrar</label>
                        <div class="flex flex-wrap gap-3 text-[10px]">
                            <label class="flex items-center gap-1 text-gray-300">
                                <input type="checkbox" id="metric-ingreso" checked class="accent-emerald-500"> üí∞ Ingreso (Total Ventas)
                            </label>
                            <label class="flex items-center gap-1 text-gray-300">
                                <input type="checkbox" id="metric-flujo" class="accent-emerald-500"> üíµ Flujo (Total Pagos)
                            </label>
                            <label class="flex items-center gap-1 text-gray-300">
                                <input type="checkbox" id="metric-costo" class="accent-emerald-500"> üì¶ Costo de Ventas
                            </label>
                            <label class="flex items-center gap-1 text-gray-300">
                                <input type="checkbox" id="metric-gastos" class="accent-emerald-500"> üßæ Gastos
                            </label>
                            <label class="flex items-center gap-1 text-gray-300">
                                <input type="checkbox" id="metric-utilidad-bruta" class="accent-emerald-500"> üìä Utilidad Bruta
                            </label>
                            <label class="flex items-center gap-1 text-gray-300">
                                <input type="checkbox" id="metric-utilidad-admin" class="accent-emerald-500"> üìà Utilidad Administrativa
                            </label>
                        </div>
                    </div>
                </div>

                <div class="p-6 space-y-6">
                    <div class="relative">
                        <div class="absolute top-0 left-0 bg-emerald-500/10 text-emerald-400 text-[10px] font-bold px-2 py-1 rounded-br border-b border-r border-emerald-500/20">FLUJO FINANCIERO</div>
                        <div id="chart-ventas-main" class="h-72 bg-slate-800/30 rounded-lg border border-white/5 flex items-center justify-center relative overflow-hidden">
                            <p class="text-emerald-500/30 font-cyber text-xs animate-pulse">Iniciando protocolo de visualizaci√≥n...</p>
                        </div>
                    </div>
                    <div id="charts-ventas-dynamic" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"></div>
                    <div class="overflow-x-auto rounded-lg border border-white/10 shadow-2xl">
                        <table id="table-ventas">
                            <thead>
                                <tr>
                                    <th>üìó Folio Venta</th>
                                    <th>üìÖ Fecha Venta</th>
                                    <th>Total Venta (Ingreso)</th>
                                    <th>Costo Calc. (Egresos)</th>
                                    <th>Utilidad Bruta</th>
                                    <th>Ref Recepci√≥n/Anticipo</th>
                                    <th>Dispositivo (Ref)</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-white/5"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- 2. RECEPCI√ìN (Azul) -->
        <section class="glass border-l-4 border-blue-500 overflow-hidden relative group">
            <div id="bg-recepcion" class="absolute inset-0 opacity-[0.08] bg-cover bg-center pointer-events-none grayscale group-hover:grayscale-0 transition-all duration-1000"></div>
            
            <div class="p-5 cursor-pointer hover:bg-white/5 transition-colors flex justify-between items-center" onclick="toggleSection('recepcion')">
                <div class="flex items-center gap-4">
                    <div class="bg-blue-900/30 p-2 rounded-lg border border-blue-500/30">
                        <span class="text-2xl">üìò</span>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-blue-400 font-cyber tracking-wide">FORMATOS DE RECEPCI√ìN</h2>
                        <p class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Servicios T√©cnicos y Diagn√≥sticos</p>
                    </div>
                </div>
                <div class="flex items-center gap-6">
                    <button class="hidden sm:flex items-center gap-1 bg-blue-500/10 hover:bg-blue-500/20 text-blue-400 px-2 py-1 rounded border border-blue-500/30 text-[10px] font-bold uppercase transition-all" onclick="event.stopPropagation(); syncFilters('ventas', 'recepcion')">
                        <span>‚ö°</span> Heredar Filtros Venta
                    </button>
                    <div class="text-right hidden sm:block">
                        <p class="text-[9px] text-gray-500 uppercase font-bold">Folios Filtrados</p>
                        <p id="kpi-recepcion-count" class="text-blue-400 font-bold kpi-value text-xl">0</p>
                    </div>
                    <span id="icon-recepcion" class="text-gray-500 transform -rotate-90 transition-transform duration-300">‚ñº</span>
                </div>
            </div>

            <div id="content-recepcion" class="collapsible-content border-t border-white/5">
                <div class="p-4 grid grid-cols-1 md:grid-cols-5 gap-4 bg-slate-900/40 backdrop-blur-sm">
                    <div class="space-y-1">
                        <label class="text-[9px] text-blue-500 font-bold uppercase tracking-wider">Validez‚úÖ</label>
                        <select id="filter-recepcion-validez" class="w-full bg-slate-800 text-xs border border-slate-600 rounded p-1.5 text-gray-300"><option value="V√°lido" selected>V√°lido</option><option value="ALL">Todos</option></select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[9px] text-blue-500 font-bold uppercase tracking-wider">EstatusüîÑÔ∏è</label>
                        <select class="w-full bg-slate-800 text-xs border border-slate-600 rounded p-1.5 text-gray-300"><option>Todos</option></select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[9px] text-blue-500 font-bold uppercase tracking-wider">Vigencia‚åõ</label>
                        <select class="w-full bg-slate-800 text-xs border border-slate-600 rounded p-1.5 text-gray-300"><option>Todas</option></select>
                    </div>
                </div>

                <div class="p-6 space-y-6">
                    <div class="relative">
                        <div class="absolute top-0 left-0 bg-blue-500/10 text-blue-400 text-[10px] font-bold px-2 py-1 rounded-br border-b border-r border-blue-500/20">ACUMULACI√ìN DIARIA</div>
                        <div id="chart-recepcion-main" class="h-48 bg-slate-800/30 rounded-lg border border-white/5 flex items-center justify-center">
                            <p class="text-blue-500/30 font-cyber text-xs">Visualizaci√≥n de Servicios...</p>
                        </div>
                    </div>
                    <div id="charts-recepcion-dynamic" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"></div>
                    <div class="overflow-x-auto rounded-lg border border-white/10 shadow-2xl">
                        <table id="table-recepcion">
                            <thead>
                                <tr>
                                    <th>üìò Folio Recepci√≥n</th>
                                    <th>üìÖ Fecha Recepci√≥n</th>
                                    <th>1Ô∏è‚É£ Tipo Solicitud</th>
                                    <th>¬ÆÔ∏è Marca / üì± Modelo</th>
                                    <th>‚öôÔ∏è Tipo Servicio</th>
                                    <th>üí≤ Serv. M√≠nimo</th>
                                    <th>üí° Enciende</th>
                                    <th>üíß Mojado</th>
                                    <th>üìí Ant. Vinculado</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-white/5"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- 3. ANTICIPOS (Amarillo) -->
        <section class="glass border-l-4 border-yellow-500 overflow-hidden relative group">
            <div id="bg-anticipos" class="absolute inset-0 opacity-[0.08] bg-cover bg-center pointer-events-none grayscale group-hover:grayscale-0 transition-all duration-1000"></div>
            
            <div class="p-5 cursor-pointer hover:bg-white/5 transition-colors flex justify-between items-center" onclick="toggleSection('anticipos')">
                <div class="flex items-center gap-4">
                    <div class="bg-yellow-900/30 p-2 rounded-lg border border-yellow-500/30">
                        <span class="text-2xl">üìí</span>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-yellow-400 font-cyber tracking-wide">ANTICIPOS</h2>
                        <p class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Gesti√≥n de Pagos Parciales</p>
                    </div>
                </div>
                <div class="flex items-center gap-6">
                    <div class="text-right hidden md:block">
                        <p class="text-[9px] text-gray-500 uppercase font-bold">Total Acumulado</p>
                        <p id="kpi-anticipos-total" class="text-yellow-400 font-bold kpi-value text-xl">$0.00</p>
                    </div>
                    <span id="icon-anticipos" class="text-gray-500 transform -rotate-90 transition-transform duration-300">‚ñº</span>
                </div>
            </div>

            <div id="content-anticipos" class="collapsible-content border-t border-white/5">
                <div class="p-6 space-y-6">
                    <div id="charts-anticipos-dynamic" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"></div>
                    
                    <div class="overflow-x-auto rounded-lg border border-white/10 shadow-2xl">
                        <table id="table-anticipos">
                            <thead>
                                <tr>
                                    <th>üìí Folio Anticipo</th>
                                    <th>üìÖ Fecha Anticipo</th>
                                    <th>Monto</th>
                                    <th>üìò Ref Recepci√≥n</th>
                                    <th>Dispositivo (Ref)</th>
                                    <th>Estatus</th>
                                    <th>Vigencia</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-white/5"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- 4. EGRESOS / COMPRAS (Rojo) -->
        <section class="glass border-l-4 border-red-600 overflow-hidden relative group">
            <div id="bg-egresos" class="absolute inset-0 opacity-[0.08] bg-cover bg-center pointer-events-none grayscale group-hover:grayscale-0 transition-all duration-1000"></div>
            
            <div class="p-5 cursor-pointer hover:bg-white/5 transition-colors flex justify-between items-center" onclick="toggleSection('egresos')">
                <div class="flex items-center gap-4">
                    <div class="bg-red-900/30 p-2 rounded-lg border border-red-500/30">
                        <span class="text-2xl">üìï</span>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-red-500 font-cyber tracking-wide">EGRESOS Y COMPRAS</h2>
                        <p class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Compras de Refacciones y Gastos</p>
                    </div>
                </div>
                <div class="flex items-center gap-6">
                    <div class="text-right hidden md:block">
                        <p class="text-[9px] text-gray-500 uppercase font-bold">Total Salidas</p>
                        <p id="kpi-egresos-total" class="text-red-400 font-bold kpi-value text-xl">$0.00</p>
                    </div>
                    <span id="icon-egresos" class="text-gray-500 transform -rotate-90 transition-transform duration-300">‚ñº</span>
                </div>
            </div>

            <div id="content-egresos" class="collapsible-content border-t border-white/5">
                <div class="p-4 grid grid-cols-1 md:grid-cols-4 gap-4 bg-slate-900/40 backdrop-blur-sm">
                    <div class="space-y-1">
                        <label class="text-[9px] text-red-500 font-bold uppercase tracking-wider">Filtro: Tipo</label>
                        <select id="filter-egresos-tipo" class="w-full bg-slate-800 text-xs border border-slate-600 rounded p-1.5 text-gray-300 font-medium"><option value="ALL">Todos (Compra/Gasto)</option><option value="Compra">Compra</option><option value="Gasto/Pago">Gasto/Pago</option></select>
                    </div>
                </div>

                <div class="p-6 space-y-6">
                    <div id="charts-egresos-dynamic" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"></div>
                    <div class="overflow-x-auto rounded-lg border border-white/10 shadow-2xl">
                        <table id="table-egresos">
                            <thead>
                                <tr>
                                    <th>üìï Folio</th>
                                    <th>Fecha</th>
                                    <th>Tipo</th>
                                    <th>Subtipo</th>
                                    <th>Monto</th>
                                    <th>Proveedor</th>
                                    <th>Ref Vinculada (Rec/Ant)</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-white/5"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- Scripts de L√≥gica (GOOGLE SHEETS EDITION) -->
    <script>
        // ID de la hoja de c√°lculo
        const SHEET_ID = '1wci9zwPk8EUMW8RrWsZQpPToOYso8NXxZXBMbWyxK94';
        
        // URLs construidas para la API de visualizaci√≥n de Google
        const SHEET_URLS = {
            // Nota: %20 reemplaza los espacios en el nombre de la hoja
            RECEPCIONES: `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Respuestas%20a%20formulario%206`,
            VENTAS: `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Ventas_ZR`,
            ANTICIPOS: `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Anticipos_ZR`,
            EGRESOS: `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Egresos`
        };

        // Estado Global
        let GLOBAL_DATA = {
            recepciones: [],
            ventas: [],
            anticipos: [],
            egresos: []
        };

        // --- UTILS ---
        const cleanMoney = (val) => {
            if (!val) return 0;
            if (typeof val === 'number') return val;
            return parseFloat(val.toString().replace(/[$,\s]/g, '')) || 0;
        };

        const formatDate = (val) => val || '-';

        const formatMoney = (amount) => {
            return '$' + amount.toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };

        // --- CARGA DE DATOS (CSV) ---
        function loadAllData() {
            document.getElementById('loading-bar').style.opacity = '1';
            
            // Usamos Promise.all para cargar todos los CSV en paralelo
            Promise.all([
                fetchCsv(SHEET_URLS.RECEPCIONES),
                fetchCsv(SHEET_URLS.VENTAS),
                fetchCsv(SHEET_URLS.ANTICIPOS),
                fetchCsv(SHEET_URLS.EGRESOS)
            ]).then(([recData, venData, antData, egrData]) => {
                console.log("Datos CSV cargados:", recData.length, venData.length, antData.length, egrData.length);
                processData(recData, venData, antData, egrData);
                document.getElementById('loading-bar').style.opacity = '0';
            }).catch(error => {
                console.error("Error cargando CSVs:", error);
                document.getElementById('loading-bar').style.backgroundColor = 'red';
                alert("Error al cargar datos. Verifique que la hoja de Google Sheets est√© publicada en la web (Archivo > Compartir > Publicar en la web).");
            });
        }

        // Helper para fetch y parseo de CSV
        function fetchCsv(url) {
            return new Promise((resolve, reject) => {
                Papa.parse(url, {
                    download: true,
                    header: true, // Usa la primera fila como encabezados
                    complete: (results) => resolve(results.data),
                    error: (error) => reject(error)
                });
            });
        }

        function processData(rawRec, rawVen, rawAnt, rawEgr) {
            // 1. Crear Mapas para B√∫squeda R√°pida
            const recMap = rawRec.reduce((acc, item) => {
                if(item['Folio##Recepci√≥n']) acc[item['Folio##Recepci√≥n']] = item;
                return acc;
            }, {});

            const antMap = rawAnt.reduce((acc, item) => {
                if(item['Folio##Anticipo']) acc[item['Folio##Anticipo']] = item;
                return acc;
            }, {});

            // 2. Procesar EGRESOS
            GLOBAL_DATA.egresos = rawEgr.map(e => ({
                ...e,
                folio: e['Folio Egreso'] || 'S/N',
                tipo: e['Tipo'],
                subtipo: e['Subtipo'],
                monto: cleanMoney(e['Monto']),
                fecha: e['Fecha Orden Compra'] || e['Hora de Registro'],
                ref_rec: e['##Recepci√≥n'],
                ref_ant: e['##Anticipo'],
                validez: e['Validez'],
                proveedor: e['Proveedor']
            }));

            // 3. Procesar RECEPCIONES
            GLOBAL_DATA.recepciones = rawRec.map(r => {
                const antVinculado = antMap[r['Anticipo (ID) que dej√≥']];
                return {
                    ...r,
                    folio: r['Folio Recepci√≥n'],
                    fecha: r['Fecha Recepci√≥n'],
                    monto: cleanMoney(r['Servicio M√≠nimo']),
                    tipo_sol: r['1Ô∏è‚É£Tipo Solicitud'],
                    marca_modelo: `${r['¬ÆÔ∏èMarca'] || ''} ${r['üì±Modelo'] || ''}`,
                    tipo_serv: r['‚öôÔ∏èTipo Servicio'],
                    enciende: r['üí°Enciende'],
                    mojado: r['üíßMojado'],
                    ant_ref: r['Folio Anticipo'] || '-', 
                    validez: r['Validez']
                };
            });

            // 4. Procesar ANTICIPOS
            GLOBAL_DATA.anticipos = rawAnt.map(a => ({
                ...a,
                folio: a['Folio Anticipo'],
                fecha: a['Fecha Anticipo'],
                monto: cleanMoney(a['Cantidad Anticipo']),
                ref_rec_display: a['Folio Recepci√≥n'], 
                validez: a['Validez'],
                estatus: a['Estatus'],
                vigencia: a['Vigencia']
            }));

            // 5. Procesar VENTAS (C√°lculo de Utilidad)
            GLOBAL_DATA.ventas = rawVen.map(v => {
                const folioRecVenta = v['Folio##Recepci√≥n'];
                const folioAntVenta = v['Datos##Anticipo']; 
                const recData = recMap[folioRecVenta] || {};
                
                // Costo = Suma de Egresos vinculados
                const costosRelacionados = GLOBAL_DATA.egresos.filter(e => 
                    (e.tipo === 'Compra') && 
                    (
                        (folioRecVenta && e.ref_rec === folioRecVenta) ||
                        (folioAntVenta && e.ref_ant === folioAntVenta)
                    )
                );
                
                const costoTotal = costosRelacionados.reduce((sum, e) => sum + e.monto, 0);
                const ingresoTotal = cleanMoney(v['Total Venta']);

                return {
                    ...v,
                    folio: v['Folio Venta'],
                    fecha: v['Fecha ef-Venta'] || v['Fecha Venta'],
                    ingreso: ingresoTotal,
                    costo: costoTotal,
                    utilidad: ingresoTotal - costoTotal,
                    dispositivo_ref: recData['Dispositivo'] || 'N/A',
                    validez: v['Validez'],
                    folio_rec_vinculado: v['Folio Recepci√≥n Final']
                };
            });

            renderAll();
        }

        // --- NUEVAS FUNCIONES PARA AN√ÅLISIS FINANCIERO ---
        
        // Calcular fechas seg√∫n per√≠odo seleccionado
        function getPeriodDates(period, customDate = null) {
            const now = customDate || new Date();
            let startDate, endDate;
            
            switch(period) {
                case 'este-mes':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    break;
                case 'este-bimestre':
                    // Determinar bimestre actual (0-1, 2-3, 4-5, 6-7, 8-9, 10-11)
                    const bimestreStart = Math.floor(now.getMonth() / 2) * 2;
                    startDate = new Date(now.getFullYear(), bimestreStart, 1);
                    endDate = new Date(now.getFullYear(), bimestreStart + 2, 0);
                    break;
                case 'este-trimestre':
                    // Determinar trimestre actual (0-2, 3-5, 6-8, 9-11)
                    const trimestreStart = Math.floor(now.getMonth() / 3) * 3;
                    startDate = new Date(now.getFullYear(), trimestreStart, 1);
                    endDate = new Date(now.getFullYear(), trimestreStart + 3, 0);
                    break;
                case 'este-semestre':
                    // Determinar semestre actual (0-5, 6-11)
                    const semestreStart = Math.floor(now.getMonth() / 6) * 6;
                    startDate = new Date(now.getFullYear(), semestreStart, 1);
                    endDate = new Date(now.getFullYear(), semestreStart + 6, 0);
                    break;
                case 'este-a√±o':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    endDate = new Date(now.getFullYear(), 11, 31);
                    break;
                default:
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            }
            return { startDate, endDate };
        }

        // Obtener datos de per√≠odos anteriores para comparaci√≥n
        function getComparisonPeriods(basePeriod) {
            const comparisons = [];
            const checkboxes = {
                anterior: document.getElementById('comp-anterior')?.checked,
                segundo: document.getElementById('comp-segundo')?.checked,
                a√±oAnterior: document.getElementById('comp-a√±o-anterior')?.checked
            };

            const { startDate, endDate } = basePeriod;
            const diffMs = endDate - startDate;
            const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));

            if (checkboxes.anterior) {
                // More robust date calculation using milliseconds
                const prevEnd = new Date(startDate.getTime() - 24 * 60 * 60 * 1000);
                const prevStart = new Date(prevEnd.getTime() - (diffDays - 1) * 24 * 60 * 60 * 1000);
                comparisons.push({ 
                    label: 'Per√≠odo Anterior', 
                    startDate: prevStart, 
                    endDate: prevEnd,
                    color: 'rgba(59, 130, 246, 0.7)' // blue
                });
            }

            if (checkboxes.segundo) {
                // More robust date calculation using milliseconds
                const prev2End = new Date(startDate.getTime() - (diffDays + 1) * 24 * 60 * 60 * 1000);
                const prev2Start = new Date(prev2End.getTime() - (diffDays - 1) * 24 * 60 * 60 * 1000);
                comparisons.push({ 
                    label: '2do Per√≠odo Anterior', 
                    startDate: prev2Start, 
                    endDate: prev2End,
                    color: 'rgba(168, 85, 247, 0.7)' // purple
                });
            }

            if (checkboxes.a√±oAnterior) {
                const prevYearStart = new Date(startDate);
                prevYearStart.setFullYear(prevYearStart.getFullYear() - 1);
                const prevYearEnd = new Date(endDate);
                prevYearEnd.setFullYear(prevYearEnd.getFullYear() - 1);
                comparisons.push({ 
                    label: 'Mismo Per√≠odo A√±o Anterior', 
                    startDate: prevYearStart, 
                    endDate: prevYearEnd,
                    color: 'rgba(251, 191, 36, 0.7)' // amber
                });
            }

            return comparisons;
        }

        // Agregar datos seg√∫n tipo de agregaci√≥n
        function aggregateData(data, aggregationType) {
            if (aggregationType === 'folio') {
                return data; // Sin agregaci√≥n
            }

            const grouped = {};
            
            data.forEach(item => {
                const date = new Date(item.fecha);
                let key;

                switch(aggregationType) {
                    case 'dia':
                        key = date.toISOString().split('T')[0]; // YYYY-MM-DD
                        break;
                    case 'semana':
                        // Calculate week number using simple calendar weeks (not ISO 8601)
                        // Week 1 starts on Jan 1st, regardless of day of week
                        // This provides consistent grouping for business reporting
                        const firstDay = new Date(date.getFullYear(), 0, 1);
                        const dayOfYear = Math.floor((date - firstDay) / (24 * 60 * 60 * 1000));
                        const weekNum = Math.ceil((dayOfYear + firstDay.getDay() + 1) / 7);
                        key = `${date.getFullYear()}-W${weekNum.toString().padStart(2, '0')}`;
                        break;
                    case 'mes':
                        key = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                        break;
                }

                if (!grouped[key]) {
                    grouped[key] = {
                        fecha: key,
                        ingreso: 0,
                        costo: 0,
                        utilidad: 0,
                        count: 0,
                        folios: []
                    };
                }

                grouped[key].ingreso += item.ingreso;
                grouped[key].costo += item.costo;
                grouped[key].utilidad += item.utilidad;
                grouped[key].count++;
                grouped[key].folios.push(item.folio);
            });

            return Object.values(grouped).sort((a, b) => a.fecha.localeCompare(b.fecha));
        }

        // Filtrar datos por rango de fechas
        function filterDataByDateRange(data, startDate, endDate) {
            return data.filter(item => {
                const itemDate = new Date(item.fecha);
                return itemDate >= startDate && itemDate <= endDate;
            });
        }

        // Calcular m√©tricas financieras
        function calculateFinancialMetrics(ventasData, egresosData, period) {
            const metrics = {
                ingreso: 0,
                flujo: 0,
                costoVentas: 0,
                gastos: 0,
                utilidadBruta: 0,
                utilidadAdmin: 0
            };

            // Ingreso (Total Ventas)
            metrics.ingreso = ventasData.reduce((sum, v) => sum + v.ingreso, 0);

            // Flujo (Total Pagos) - usamos el campo 'Total Pagos' si existe
            metrics.flujo = ventasData.reduce((sum, v) => sum + cleanMoney(v['Total Pagos'] || v.ingreso), 0);

            // Costo de Ventas (ya calculado en processData)
            metrics.costoVentas = ventasData.reduce((sum, v) => sum + v.costo, 0);

            // Gastos del per√≠odo
            const periodEgresos = filterDataByDateRange(egresosData, period.startDate, period.endDate);
            metrics.gastos = periodEgresos
                .filter(e => e.tipo === 'Gasto/Pago')
                .reduce((sum, e) => sum + e.monto, 0);

            // Utilidades calculadas
            metrics.utilidadBruta = metrics.ingreso - metrics.costoVentas;
            metrics.utilidadAdmin = metrics.utilidadBruta - metrics.gastos;

            return metrics;
        }

        // --- RENDERIZADO DE INTERFAZ ---
        function renderAll() {
            renderVentas();
            renderRecepcion();
            renderAnticipos();
            renderEgresos();
            // generateThematicImages(); // Opcional si tienes API key
        }

        function renderVentas() {
            const validezFilter = document.getElementById('filter-ventas-validez')?.value || 'V√°lido';
            const fixedCosts = parseFloat(document.getElementById('fixed-costs-input')?.value || 0);
            const periodoValue = document.getElementById('filter-ventas-periodo')?.value || 'este-mes';
            const agregacionValue = document.getElementById('filter-ventas-agregacion')?.value || 'folio';
            
            // Filtrar por validez primero
            let filtered = GLOBAL_DATA.ventas.filter(v => validezFilter === 'ALL' || v.validez === validezFilter);

            // Obtener per√≠odo actual
            const currentPeriod = getPeriodDates(periodoValue);
            
            // Filtrar por per√≠odo
            filtered = filterDataByDateRange(filtered, currentPeriod.startDate, currentPeriod.endDate);
            
            // Agregar datos seg√∫n tipo de agregaci√≥n
            const aggregated = aggregateData(filtered, agregacionValue);

            // Verificar si hay comparaci√≥n activa
            const hasComparison = !document.getElementById('comp-ninguno')?.checked;
            const comparisons = hasComparison ? getComparisonPeriods(currentPeriod) : [];

            // Calcular m√©tricas para el per√≠odo actual
            const currentMetrics = calculateFinancialMetrics(filtered, GLOBAL_DATA.egresos, currentPeriod);
            currentMetrics.utilidadAdmin -= fixedCosts; // Restar costos fijos

            // Actualizar KPIs
            const kpiTotal = document.getElementById('kpi-ventas-total');
            const kpiUtil = document.getElementById('kpi-ventas-utilidad');
            if(kpiTotal) kpiTotal.textContent = formatMoney(currentMetrics.ingreso);
            if(kpiUtil) {
                const utilidadDisplay = currentMetrics.utilidadAdmin;
                kpiUtil.textContent = formatMoney(utilidadDisplay);
                kpiUtil.className = utilidadDisplay >= 0 ? "text-white font-bold kpi-value text-xl" : "text-red-500 font-bold kpi-value text-xl";
            }

            // Obtener m√©tricas seleccionadas
            const selectedMetrics = {
                ingreso: document.getElementById('metric-ingreso')?.checked,
                flujo: document.getElementById('metric-flujo')?.checked,
                costo: document.getElementById('metric-costo')?.checked,
                gastos: document.getElementById('metric-gastos')?.checked,
                utilidadBruta: document.getElementById('metric-utilidad-bruta')?.checked,
                utilidadAdmin: document.getElementById('metric-utilidad-admin')?.checked
            };

            // Renderizar gr√°fica principal
            renderVentasChart(currentMetrics, selectedMetrics, hasComparison, comparisons, fixedCosts);

            renderMiniCharts('charts-ventas-dynamic', ['Total Venta', 'Total Pagos', 'Dispositivo', 'Marca'], 'emerald');

            // Renderizar tabla
            const tbody = document.querySelector('#table-ventas tbody');
            if (agregacionValue === 'folio') {
                tbody.innerHTML = aggregated.slice(0, 100).map(v => `
                    <tr>
                        <td class="text-emerald-400 font-bold">${v.folio || '-'}</td>
                        <td>${formatDate(v.fecha)}</td>
                        <td class="font-mono text-right">${formatMoney(v.ingreso)}</td>
                        <td class="font-mono text-right text-red-400">${formatMoney(v.costo)}</td>
                        <td class="font-mono text-right ${v.utilidad >= 0 ? 'text-green-400' : 'text-red-400'} font-bold">${formatMoney(v.utilidad)}</td>
                        <td class="text-gray-400 text-[10px]">${v.folio_rec_vinculado || '-'} / ${v['Datos##Anticipo'] || '-'}</td>
                        <td class="text-gray-300 text-[10px]">${v.dispositivo_ref}</td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = aggregated.slice(0, 100).map(v => `
                    <tr>
                        <td class="text-emerald-400 font-bold">${v.folios.slice(0, 3).join(', ')}${v.count > 3 ? '...' : ''}</td>
                        <td>${v.fecha}</td>
                        <td class="font-mono text-right">${formatMoney(v.ingreso)}</td>
                        <td class="font-mono text-right text-red-400">${formatMoney(v.costo)}</td>
                        <td class="font-mono text-right ${v.utilidad >= 0 ? 'text-green-400' : 'text-red-400'} font-bold">${formatMoney(v.utilidad)}</td>
                        <td class="text-gray-400 text-[10px]" colspan="2">${v.count} ventas agrupadas</td>
                    </tr>
                `).join('');
            }
        }

        // Nueva funci√≥n para renderizar la gr√°fica de ventas
        function renderVentasChart(metrics, selectedMetrics, hasComparison, comparisons, fixedCosts) {
            const chart = document.getElementById('chart-ventas-main');
            if (!chart) return;

            if (!hasComparison) {
                // Modo sin comparaci√≥n: mostrar barras con √°reas de utilidad/p√©rdida
                const metricsToShow = [];
                
                if (selectedMetrics.ingreso) metricsToShow.push({ label: 'üí∞ Ingreso', value: metrics.ingreso, color: 'emerald' });
                if (selectedMetrics.flujo) metricsToShow.push({ label: 'üíµ Flujo', value: metrics.flujo, color: 'cyan' });
                if (selectedMetrics.costo) metricsToShow.push({ label: 'üì¶ Costo Ventas', value: metrics.costoVentas, color: 'blue' });
                if (selectedMetrics.gastos) metricsToShow.push({ label: 'üßæ Gastos', value: metrics.gastos, color: 'orange' });
                if (selectedMetrics.utilidadBruta) metricsToShow.push({ label: 'üìä Util. Bruta', value: metrics.utilidadBruta, color: metrics.utilidadBruta >= 0 ? 'green' : 'red' });
                if (selectedMetrics.utilidadAdmin) metricsToShow.push({ label: 'üìà Util. Admin', value: metrics.utilidadAdmin, color: metrics.utilidadAdmin >= 0 ? 'green' : 'red' });

                if (metricsToShow.length === 0) {
                    chart.innerHTML = '<p class="text-emerald-500/30 font-cyber text-xs animate-pulse">Seleccione al menos una m√©trica...</p>';
                    return;
                }

                const maxVal = Math.max(...metricsToShow.map(m => Math.abs(m.value))) * 1.2 || 100;
                
                const colorMap = {
                    'emerald': 'bg-emerald-500/80 border-emerald-400/30 shadow-[0_0_15px_rgba(16,185,129,0.4)]',
                    'cyan': 'bg-cyan-500/80 border-cyan-400/30 shadow-[0_0_15px_rgba(6,182,212,0.4)]',
                    'blue': 'bg-blue-600/80 border-blue-400/30 shadow-[0_0_15px_rgba(37,99,235,0.4)]',
                    'orange': 'bg-orange-500/80 border-orange-400/30 shadow-[0_0_15px_rgba(249,115,22,0.4)]',
                    'green': 'bg-green-500/80 border-green-400/30 shadow-[0_0_15px_rgba(34,197,94,0.4)]',
                    'red': 'bg-red-600/80 border-red-400/30 shadow-[0_0_15px_rgba(220,38,38,0.4)]'
                };

                const barsHTML = metricsToShow.map(m => {
                    const height = (Math.abs(m.value) / maxVal) * 100;
                    const isNegative = m.value < 0;
                    
                    // Get text color class based on metric color
                    const textColorMap = {
                        'emerald': 'green',
                        'green': 'green',
                        'red': 'red',
                        'cyan': 'cyan',
                        'blue': 'blue',
                        'orange': 'orange'
                    };
                    const textColor = textColorMap[m.color] || 'gray';
                    
                    return `
                        <div class="w-24 flex flex-col ${isNegative ? 'justify-start' : 'justify-end'} items-center group relative cursor-pointer">
                            <div class="w-full ${colorMap[m.color]} rounded-t-sm transition-all duration-1000 border-x border-t" style="height: ${height}%"></div>
                            <p class="mt-3 text-[9px] uppercase font-bold text-gray-400 tracking-widest text-center">${m.label}</p>
                            <div class="absolute -bottom-8 text-xs font-bold text-${textColor}-400">${formatMoney(m.value)}</div>
                        </div>
                    `;
                }).join('');

                chart.innerHTML = `
                    <div class="relative w-full h-full p-6 flex items-end justify-center gap-8 overflow-x-auto">
                        ${barsHTML}
                    </div>
                `;
            } else {
                // Modo con comparaci√≥n: mostrar datos de m√∫ltiples per√≠odos
                chart.innerHTML = `
                    <div class="relative w-full h-full p-6 flex flex-col items-center justify-center">
                        <p class="text-emerald-400 font-cyber text-sm mb-4">COMPARACI√ìN DE PER√çODOS</p>
                        <div class="space-y-3 w-full max-w-2xl">
                            <div class="flex justify-between items-center p-3 bg-emerald-500/10 rounded border border-emerald-500/30">
                                <span class="text-xs text-gray-300">Per√≠odo Actual</span>
                                <span class="text-sm font-bold text-emerald-400">${formatMoney(metrics.ingreso)}</span>
                            </div>
                            ${comparisons.map(comp => {
                                // Aqu√≠ deber√≠amos calcular m√©tricas para cada per√≠odo de comparaci√≥n
                                // Por ahora mostramos placeholder
                                return `
                                    <div class="flex justify-between items-center p-3 bg-slate-800/30 rounded border border-slate-600/30">
                                        <span class="text-xs text-gray-300">${comp.label}</span>
                                        <span class="text-sm font-bold text-gray-400">En desarrollo...</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }
        }

        function renderRecepcion() {
            const validezFilter = document.getElementById('filter-recepcion-validez')?.value || 'V√°lido';
            const filtered = GLOBAL_DATA.recepciones.filter(r => validezFilter === 'ALL' || r.validez === validezFilter);
            document.getElementById('kpi-recepcion-count').textContent = filtered.length;

            const tbody = document.querySelector('#table-recepcion tbody');
            tbody.innerHTML = filtered.slice(0, 100).map(r => `
                <tr>
                    <td class="text-blue-400 font-bold">${r.folio || '-'}</td>
                    <td>${formatDate(r.fecha)}</td>
                    <td class="text-[10px] uppercase">${r.tipo_sol || '-'}</td>
                    <td class="text-[10px] text-gray-300">${r.marca_modelo}</td>
                    <td class="text-[10px] text-blue-300">${r.tipo_serv || '-'}</td>
                    <td class="font-mono text-right">${formatMoney(r.monto)}</td>
                    <td class="text-center">${r.enciende === 'S√≠' ? 'üü¢' : 'üî¥'}</td>
                    <td class="text-center">${r.mojado === 'S√≠' ? 'üíß' : '-'}</td>
                    <td class="text-yellow-500 font-bold text-[10px]">${r.ant_ref}</td>
                </tr>
            `).join('');
            renderMiniCharts('charts-recepcion-dynamic', ['1Ô∏è‚É£Tipo Solicitud', '‚öôÔ∏èTipo Servicio', '¬ÆÔ∏èMarca', 'üíßMojado'], 'blue');
        }

        function renderAnticipos() {
            const filtered = GLOBAL_DATA.anticipos.filter(a => a.validez === 'V√°lido'); 
            const totalAnt = filtered.reduce((s, a) => s + a.monto, 0);
            const kpiAnt = document.getElementById('kpi-anticipos-total');
            if(kpiAnt) kpiAnt.textContent = formatMoney(totalAnt);

            const tbody = document.querySelector('#table-anticipos tbody');
            tbody.innerHTML = filtered.slice(0, 100).map(a => `
                <tr>
                    <td class="text-yellow-400 font-bold">${a.folio || '-'}</td>
                    <td>${formatDate(a.fecha)}</td>
                    <td class="font-mono text-right font-bold text-white">${formatMoney(a.monto)}</td>
                    <td class="text-blue-400 text-[10px]">${a.ref_rec_display || '-'}</td>
                    <td class="text-gray-400 text-[10px]">${a.dispositivo_ref || '-'}</td>
                    <td class="text-[10px] uppercase tracking-wider ${a.estatus === 'Cerrado' ? 'text-green-500' : 'text-yellow-200'}">${a.estatus || '-'}</td>
                    <td class="text-[10px]">${a.vigencia || '-'}</td>
                </tr>
            `).join('');
            renderMiniCharts('charts-anticipos-dynamic', ['Estatus', 'Vigencia', 'Marca', 'Modelo'], 'yellow');
        }

        function renderEgresos() {
            const tipoFilter = document.getElementById('filter-egresos-tipo')?.value || 'ALL';
            const filtered = GLOBAL_DATA.egresos.filter(e => 
                e.validez === 'V√°lido' && 
                (tipoFilter === 'ALL' || e.tipo === tipoFilter)
            );
            const totalEgr = filtered.reduce((s, e) => s + e.monto, 0);
            const kpiEgr = document.getElementById('kpi-egresos-total');
            if(kpiEgr) kpiEgr.textContent = formatMoney(totalEgr);

            const tbody = document.querySelector('#table-egresos tbody');
            tbody.innerHTML = filtered.slice(0, 100).map(e => `
                <tr>
                    <td class="text-red-400 font-bold">${e.folio}</td>
                    <td>${formatDate(e.fecha)}</td>
                    <td class="uppercase text-[10px] font-bold">${e.tipo}</td>
                    <td class="text-gray-400 text-[10px]">${e.subtipo || '-'}</td>
                    <td class="font-mono text-right text-red-300">${formatMoney(e.monto)}</td>
                    <td class="text-[10px] text-blue-300 truncate max-w-[100px]">${e.proveedor || '-'}</td>
                    <td class="text-[10px] text-gray-500 font-mono">${e.ref_rec || e.ref_ant || ''}</td>
                </tr>
            `).join('');
            renderMiniCharts('charts-egresos-dynamic', ['Tipo', 'Subtipo', 'Proveedor', 'Estatus'], 'red');
        }

        function renderMiniCharts(containerId, labels, color) {
            const container = document.getElementById(containerId);
            if(!container) return;
            container.innerHTML = labels.map(label => `
                <div class="h-32 bg-slate-800/40 border border-${color}-500/20 rounded-lg p-3 flex flex-col justify-between hover:border-${color}-500/50 transition-colors cursor-pointer group">
                    <div class="flex justify-between items-start">
                        <p class="text-[10px] uppercase font-bold text-${color}-400 tracking-wider">${label}</p>
                    </div>
                    <div class="flex items-end gap-1 h-16 opacity-80 mt-2">
                        <div class="w-1/5 bg-gradient-to-t from-${color}-900 to-${color}-500 rounded-t-sm h-full opacity-50"></div>
                        <div class="w-1/5 bg-gradient-to-t from-${color}-900 to-${color}-500 rounded-t-sm h-3/4 opacity-50"></div>
                        <div class="w-1/5 bg-gradient-to-t from-${color}-900 to-${color}-500 rounded-t-sm h-1/2 opacity-50"></div>
                        <div class="w-1/5 bg-gradient-to-t from-${color}-900 to-${color}-500 rounded-t-sm h-1/4 opacity-50"></div>
                    </div>
                </div>
            `).join('');
        }

        // --- INICIALIZACI√ìN ---
        window.updateDashboard = renderAll;
        
        // Event listeners para los nuevos filtros
        document.addEventListener('DOMContentLoaded', function() {
            // Listener para el selector de per√≠odo
            const periodSelect = document.getElementById('filter-ventas-periodo');
            const agregacionSelect = document.getElementById('filter-ventas-agregacion');
            
            if (periodSelect) {
                periodSelect.addEventListener('change', function() {
                    updateAgregacionOptions();
                    renderVentas();
                });
            }
            
            if (agregacionSelect) {
                agregacionSelect.addEventListener('change', function() {
                    renderVentas();
                });
            }

            // Listeners para checkboxes de comparaci√≥n
            const compCheckboxes = ['comp-ninguno', 'comp-anterior', 'comp-segundo', 'comp-a√±o-anterior'];
            compCheckboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    checkbox.addEventListener('change', function() {
                        handleComparisonCheckboxes(id);
                        renderVentas();
                    });
                }
            });

            // Listeners para checkboxes de m√©tricas
            const metricCheckboxes = ['metric-ingreso', 'metric-flujo', 'metric-costo', 'metric-gastos', 'metric-utilidad-bruta', 'metric-utilidad-admin'];
            metricCheckboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    checkbox.addEventListener('change', function() {
                        renderVentas();
                    });
                }
            });
        });

        // Funci√≥n para manejar la l√≥gica de checkboxes de comparaci√≥n
        function handleComparisonCheckboxes(clickedId) {
            const ninguno = document.getElementById('comp-ninguno');
            const otros = ['comp-anterior', 'comp-segundo', 'comp-a√±o-anterior'];
            
            if (clickedId === 'comp-ninguno' && ninguno?.checked) {
                // Si se selecciona "Sin Comparar", desmarcar los dem√°s
                otros.forEach(id => {
                    const cb = document.getElementById(id);
                    if (cb) cb.checked = false;
                });
            } else if (clickedId !== 'comp-ninguno') {
                // Si se selecciona cualquier otro, desmarcar "Sin Comparar"
                if (ninguno) ninguno.checked = false;
            }
        }

        // Funci√≥n para actualizar las opciones de agregaci√≥n seg√∫n el per√≠odo
        function updateAgregacionOptions() {
            const periodSelect = document.getElementById('filter-ventas-periodo');
            const agregacionSelect = document.getElementById('filter-ventas-agregacion');
            
            if (!periodSelect || !agregacionSelect) return;
            
            const period = periodSelect.value;
            const currentValue = agregacionSelect.value;
            
            // Habilitar todas las opciones primero
            Array.from(agregacionSelect.options).forEach(opt => {
                opt.disabled = false;
            });
            
            // Deshabilitar opciones seg√∫n el per√≠odo
            if (period === 'este-mes' || period === 'elegir-mes') {
                // En per√≠odo mensual, deshabilitar "Por Mes"
                Array.from(agregacionSelect.options).forEach(opt => {
                    if (opt.value === 'mes') {
                        opt.disabled = true;
                        if (currentValue === 'mes') {
                            agregacionSelect.value = 'folio';
                        }
                    }
                });
            }
            
            if (period === 'este-a√±o') {
                // En per√≠odo anual, todas las opciones disponibles
                // No hacer nada adicional
            } else {
                // Para per√≠odos menores que a√±o, asegurar que "Por Mes" no est√© disponible
                Array.from(agregacionSelect.options).forEach(opt => {
                    if (opt.value === 'mes') {
                        opt.disabled = true;
                    }
                });
            }
        }

        window.onload = loadAllData; // Iniciar carga al abrir

    </script>

    <script>
        // Funciones UI globales
        function toggleSection(id) {
            const content = document.getElementById('content-' + id);
            const icon = document.getElementById('icon-' + id);
            if(content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                icon.style.transform = 'rotate(-90deg)';
            } else {
                content.classList.add('expanded');
                icon.style.transform = 'rotate(0deg)';
            }
        }
        function expandAll() { document.querySelectorAll('.collapsible-content').forEach(e => e.classList.add('expanded')); }
        function collapseAll() { document.querySelectorAll('.collapsible-content').forEach(e => e.classList.remove('expanded')); }
        function syncFilters(from, to) { alert(`Filtros de ${from} aplicados a ${to}`); }
    </script>
</body>
</html>
