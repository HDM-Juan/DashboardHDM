<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital de MÃ³vil - Dashboard</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PapaParse para leer Google Sheets -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <!-- Chart.js para grÃ¡ficos reales (si se requiere mÃ¡s adelante, por ahora usaremos HTML/CSS bars) -->

    <!-- Fuentes Corporativas -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@100..900&display=swap');
        
        :root {
            --bg-dark: #060c0e;
            --corporate-red: #ea412c;
            --corporate-red-dark: #a41a09;
            --corporate-red-darker: #a31f0f;
            --text-main: #fcfafa;
            --text-muted: #979797;

            --glass-bg: rgba(6, 12, 14, 0.85);
            --glass-border: rgba(151, 151, 151, 0.1);
        }

        body { 
            font-family: 'Montserrat', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            background-image: 
                linear-gradient(rgba(6, 12, 14, 0.95), rgba(6, 12, 14, 0.98)),
                url('https://www.transparenttextures.com/patterns/carbon-fibre.png');
            background-attachment: fixed;
        }

        /* Efecto Glassmorphism */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 0.75rem;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }

        /* Encabezados */
        .metallic-header {
            background: linear-gradient(180deg, #1a1a1a 0%, var(--bg-dark) 100%);
            border-bottom: 3px solid var(--corporate-red);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }

        /* Animaciones */
        .collapsible-content {
            transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.5s ease;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        .collapsible-content.expanded {
            max-height: 20000px;
            opacity: 1;
        }

        /* Tablas */
        table { border-collapse: separate; border-spacing: 0; width: 100%; }
        thead th { 
            background: rgba(30, 41, 59, 0.9);
            color: var(--text-main);
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 0.05em;
            padding: 12px;
            border-bottom: 2px solid var(--corporate-red-dark);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        tbody tr { background: rgba(255, 255, 255, 0.01); transition: all 0.2s; }
        tbody tr:hover { background: rgba(234, 65, 44, 0.1); transform: translateX(2px); }
        td { 
            padding: 10px 12px;
            border-bottom: 1px solid rgba(151,151,151,0.1);
            font-size: 0.75rem;
            white-space: nowrap;
        }

        /* Utilidades */
        .kpi-value { font-family: 'Montserrat', sans-serif; letter-spacing: -0.5px; }
        .text-glow { text-shadow: 0 0 10px rgba(234, 65, 44, 0.5); }
        
        .btn-action {
            background: var(--corporate-red-dark);
            color: white;
            transition: all 0.2s;
        }
        .btn-action:hover { background: var(--corporate-red); }

        /* Loader */
        .loader-bar {
            height: 3px;
            width: 100%;
            background: linear-gradient(90deg, transparent, var(--corporate-red), transparent);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body class="min-h-screen">

    <!-- Navbar -->
    <nav class="metallic-header sticky top-0 z-50 px-6 py-4 flex flex-wrap justify-between items-center">
        <div class="flex items-center space-x-5">
            <div class="relative group">
                <div class="p-2 rounded-full border-2 border-[#979797] group-hover:border-[#ea412c] transition-colors bg-[#060c0e]">
                    <img src="https://i.imgur.com/6R6fPFf.gif" alt="Logo" class="w-16 h-16 rounded-full">
                </div>
            </div>
            <div>
                <h1 class="text-2xl font-black text-white leading-none tracking-tight">
                    HOSPITAL <span style="color: var(--corporate-red);" class="text-glow">DEL</span> MÃ“VIL
                </h1>
                <p class="text-xs text-[#979797] uppercase tracking-[0.2em] font-bold mt-1">Dashboard Administrativo</p>
            </div>
        </div>
        
        <div class="flex items-center gap-3 mt-4 sm:mt-0">
            <button onclick="expandAll()" class="px-3 py-1 text-xs border border-[#979797] rounded text-[#979797] hover:text-white hover:border-white transition-colors">Expandir Todo</button>
            <button onclick="collapseAll()" class="px-3 py-1 text-xs border border-[#979797] rounded text-[#979797] hover:text-white hover:border-white transition-colors">Contraer Todo</button>
            <button onclick="loadAllData()" class="btn-action px-4 py-2 rounded text-xs uppercase font-bold shadow-lg transition-all border border-[#ea412c]">
                ðŸ”„ Actualizar Datos
            </button>
        </div>
    </nav>

    <div id="loading-bar" class="loader-bar fixed top-[90px] left-0 z-40 opacity-0 transition-opacity"></div>

    <main class="p-6 space-y-8 max-w-[1800px] mx-auto pb-24">

        <!-- 1. VENTAS -->
        <section class="glass border-l-4 border-[#ea412c] overflow-hidden relative group">
            <div class="p-6 cursor-pointer hover:bg-white/5 transition-colors flex justify-between items-center" onclick="toggleSection('ventas')">
                <div class="flex items-center gap-4">
                    <div class="bg-[#a41a09]/20 p-3 rounded-lg border border-[#ea412c]/30">
                        <span class="text-2xl">ðŸ“—</span>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-[#ea412c] tracking-wide">VENTAS</h2>
                        <p class="text-xs text-[#979797] uppercase font-bold tracking-wider">Registro de Ingresos y Utilidad</p>
                    </div>
                </div>
                <div class="flex items-center gap-8">
                    <div class="text-right hidden md:block">
                        <p class="text-[10px] text-[#979797] uppercase font-bold">Total Ingreso</p>
                        <p id="kpi-ventas-total" class="text-white font-bold kpi-value text-2xl">$0.00</p>
                    </div>
                    <span id="icon-ventas" class="text-[#979797] transform -rotate-90 transition-transform duration-300">â–¼</span>
                </div>
            </div>

            <div id="content-ventas" class="collapsible-content border-t border-[#979797]/10">
                <div class="p-5 space-y-5 bg-[#060c0e]/50 backdrop-blur-sm">
                    <!-- Filtros -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-5">
                        <div class="space-y-1">
                            <label class="text-[10px] text-[#ea412c] font-bold uppercase tracking-wider">PerÃ­odo</label>
                            <select id="filter-periodo" class="w-full bg-[#060c0e] text-xs border border-[#979797]/30 rounded p-2 text-white focus:border-[#ea412c] outline-none" onchange="window.updateDashboard()">
                                <option value="este-mes" selected>Este Mes</option>
                                <option value="mes-anterior">Mes Anterior</option>
                                <option value="este-ano">Este AÃ±o</option>
                                <option value="todo">HistÃ³rico Completo</option>
                            </select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] text-[#ea412c] font-bold uppercase tracking-wider">Costo Fijo Mensual</label>
                            <input type="number" id="fixed-costs-input" value="10000" class="w-full bg-[#060c0e] text-xs border border-[#979797]/30 rounded p-2 text-white focus:border-[#ea412c] outline-none" onchange="window.updateDashboard()">
                        </div>
                    </div>
                </div>

                <div class="p-6 space-y-8">
                    <!-- GrÃ¡ficos de DistribuciÃ³n -->
                    <div>
                        <h3 class="text-xs font-bold text-[#979797] uppercase tracking-widest mb-4">DistribuciÃ³n de Datos</h3>
                        <div id="charts-ventas-dynamic" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"></div>
                    </div>

                    <!-- Tabla -->
                    <div class="overflow-x-auto rounded-lg border border-[#979797]/20 shadow-2xl">
                        <table id="table-ventas">
                            <thead>
                                <tr>
                                    <th>ðŸ“— Folio Venta</th>
                                    <th>Fecha</th>
                                    <th>Ingreso</th>
                                    <th>Costo Calc.</th>
                                    <th>Utilidad</th>
                                    <th>ðŸ“’ Folio Anticipo</th>
                                    <th>ðŸ“˜ Folio RecepciÃ³n</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-[#979797]/10"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- 2. SERVICIOS (Recepciones) -->
        <section class="glass border-l-4 border-blue-500 overflow-hidden relative group">
            <div class="p-6 cursor-pointer hover:bg-white/5 transition-colors flex justify-between items-center" onclick="toggleSection('recepcion')">
                <div class="flex items-center gap-4">
                    <div class="bg-blue-900/20 p-3 rounded-lg border border-blue-500/30">
                        <span class="text-2xl">ðŸ“˜</span>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-blue-400 tracking-wide">SERVICIOS</h2>
                        <p class="text-xs text-[#979797] uppercase font-bold tracking-wider">Recepciones y DiagnÃ³sticos</p>
                    </div>
                </div>
                <div class="flex items-center gap-8">
                    <div class="text-right hidden md:block">
                        <p class="text-[10px] text-[#979797] uppercase font-bold">Total Servicios</p>
                        <p id="kpi-recepcion-count" class="text-blue-400 font-bold kpi-value text-2xl">0</p>
                    </div>
                    <span id="icon-recepcion" class="text-[#979797] transform -rotate-90 transition-transform duration-300">â–¼</span>
                </div>
            </div>

            <div id="content-recepcion" class="collapsible-content border-t border-[#979797]/10">
                <div class="p-6 space-y-8">
                    <div>
                        <h3 class="text-xs font-bold text-[#979797] uppercase tracking-widest mb-4">DistribuciÃ³n de Datos</h3>
                        <div id="charts-recepcion-dynamic" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"></div>
                    </div>
                    <div class="overflow-x-auto rounded-lg border border-[#979797]/20 shadow-2xl">
                        <table id="table-recepcion">
                            <thead>
                                <tr>
                                    <th>ðŸ“˜ Folio RecepciÃ³n</th>
                                    <th>Fecha</th>
                                    <th>Tipo Solicitud</th>
                                    <th>Marca / Modelo</th>
                                    <th>Servicio MÃ­nimo ($)</th>
                                    <th>ðŸ“’ Folio Anticipo</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-[#979797]/10"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- 3. ANTICIPOS -->
        <section class="glass border-l-4 border-yellow-500 overflow-hidden relative group">
            <div class="p-6 cursor-pointer hover:bg-white/5 transition-colors flex justify-between items-center" onclick="toggleSection('anticipos')">
                <div class="flex items-center gap-4">
                    <div class="bg-yellow-900/20 p-3 rounded-lg border border-yellow-500/30">
                        <span class="text-2xl">ðŸ“’</span>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-yellow-400 tracking-wide">ANTICIPOS</h2>
                        <p class="text-xs text-[#979797] uppercase font-bold tracking-wider">Pagos Parciales</p>
                    </div>
                </div>
                <div class="flex items-center gap-8">
                    <div class="text-right hidden md:block">
                        <p class="text-[10px] text-[#979797] uppercase font-bold">Total Anticipos</p>
                        <p id="kpi-anticipos-total" class="text-yellow-400 font-bold kpi-value text-2xl">$0.00</p>
                    </div>
                    <span id="icon-anticipos" class="text-[#979797] transform -rotate-90 transition-transform duration-300">â–¼</span>
                </div>
            </div>

            <div id="content-anticipos" class="collapsible-content border-t border-[#979797]/10">
                <div class="p-6 space-y-8">
                    <div>
                        <h3 class="text-xs font-bold text-[#979797] uppercase tracking-widest mb-4">DistribuciÃ³n de Datos</h3>
                        <div id="charts-anticipos-dynamic" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"></div>
                    </div>
                    <div class="overflow-x-auto rounded-lg border border-[#979797]/20 shadow-2xl">
                        <table id="table-anticipos">
                            <thead>
                                <tr>
                                    <th>ðŸ“’ Folio Anticipo</th>
                                    <th>Fecha</th>
                                    <th>Monto</th>
                                    <th>ðŸ“˜ Folio RecepciÃ³n</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-[#979797]/10"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- 4. EGRESOS -->
        <section class="glass border-l-4 border-[#a31f0f] overflow-hidden relative group">
            <div class="p-6 cursor-pointer hover:bg-white/5 transition-colors flex justify-between items-center" onclick="toggleSection('egresos')">
                <div class="flex items-center gap-4">
                    <div class="bg-red-900/20 p-3 rounded-lg border border-[#a31f0f]/30">
                        <span class="text-2xl">ðŸ“•</span>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-[#ea412c] tracking-wide">EGRESOS</h2>
                        <p class="text-xs text-[#979797] uppercase font-bold tracking-wider">Compras y Gastos</p>
                    </div>
                </div>
                <div class="flex items-center gap-8">
                    <div class="text-right hidden md:block">
                        <p class="text-[10px] text-[#979797] uppercase font-bold">Total Salidas</p>
                        <p id="kpi-egresos-total" class="text-[#ea412c] font-bold kpi-value text-2xl">$0.00</p>
                    </div>
                    <span id="icon-egresos" class="text-[#979797] transform -rotate-90 transition-transform duration-300">â–¼</span>
                </div>
            </div>

            <div id="content-egresos" class="collapsible-content border-t border-[#979797]/10">
                <div class="p-6 space-y-8">
                    <div>
                        <h3 class="text-xs font-bold text-[#979797] uppercase tracking-widest mb-4">DistribuciÃ³n de Datos</h3>
                        <div id="charts-egresos-dynamic" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"></div>
                    </div>
                    <div class="overflow-x-auto rounded-lg border border-[#979797]/20 shadow-2xl">
                        <table id="table-egresos">
                            <thead>
                                <tr>
                                    <th>ðŸ“• Folio</th>
                                    <th>Fecha</th>
                                    <th>Tipo</th>
                                    <th>Subtipo</th>
                                    <th>Monto</th>
                                    <th>Refs (Venta/Ant/Rec)</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-[#979797]/10"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- LOGICA DEL DASHBOARD -->
    <script>
        const SHEET_ID = '1wci9zwPk8EUMW8RrWsZQpPToOYso8NXxZXBMbWyxK94';
        
        // URLs con 'Respuestas de formulario 6' corregido y header: false implÃ­cito en el manejo
        const SHEET_URLS = {
            RECEPCIONES: `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Respuestas%20de%20formulario%206`,
            VENTAS: `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Ventas_ZR`,
            ANTICIPOS: `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Anticipos_ZR`,
            EGRESOS: `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Egresos`
        };

        // Estado Global
        let GLOBAL_DATA = {
            recepciones: [],
            ventas: [],
            anticipos: [],
            egresos: [],
            mapRecepciones: {},
            mapAnticipos: {}
        };

        // --- UTILS ---
        const cleanMoney = (val) => {
            if (!val) return 0;
            if (typeof val === 'number') return val;
            return parseFloat(val.toString().replace(/[$,\s]/g, '')) || 0;
        };

        const formatDate = (val) => val || '-';
        const formatMoney = (amount) => '$' + amount.toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        // Parseador de fechas simple (DD/MM/YYYY)
        const parseDate = (dateStr) => {
            if (!dateStr) return null;
            const parts = dateStr.split(' ')[0].split('/'); // Ignorar hora si existe
            if (parts.length === 3) return new Date(parts[2], parts[1] - 1, parts[0]);
            return null;
        };

        // --- CARGA DE DATOS ---
        function loadAllData() {
            document.getElementById('loading-bar').style.opacity = '1';
            
            Promise.all([
                fetchCsv(SHEET_URLS.RECEPCIONES),
                fetchCsv(SHEET_URLS.VENTAS),
                fetchCsv(SHEET_URLS.ANTICIPOS),
                fetchCsv(SHEET_URLS.EGRESOS)
            ]).then(([recData, venData, antData, egrData]) => {
                console.log("Datos Raw:", recData.length, venData.length, antData.length, egrData.length);
                processData(recData, venData, antData, egrData);
                document.getElementById('loading-bar').style.opacity = '0';
            }).catch(error => {
                console.error(error);
                alert("Error cargando datos. Revisa la consola.");
            });
        }

        function fetchCsv(url) {
            return new Promise((resolve, reject) => {
                Papa.parse(url, {
                    download: true,
                    header: false, // Importante: Array de Arrays para manejar headers vacÃ­os
                    skipEmptyLines: true,
                    complete: (results) => resolve(results.data),
                    error: (error) => reject(error)
                });
            });
        }

        function getIndex(headers, ...keywords) {
            // Busca el Ã­ndice de la columna que contenga alguna de las keywords
            return headers.findIndex(h => {
                const hLower = (h || '').toString().toLowerCase();
                return keywords.some(k => hLower.includes(k.toLowerCase()));
            });
        }

        function processData(rawRec, rawVen, rawAnt, rawEgr) {
            // 1. HEADER ROWS & INDICES
            // Asumimos que la fila 0 son los headers
            const hRec = rawRec[0];
            const hVen = rawVen[0];
            const hAnt = rawAnt[0];
            const hEgr = rawEgr[0];

            // RECEPCIONES Indices
            const idxRec = {
                key: 1, // Folio##RecepciÃ³n (Fixed based on analysis)
                fecha: 2,
                label: 3, // Folio RecepciÃ³n
                tipo: 24, // Tipo Solicitud
                marca: 13,
                modelo: 14,
                monto: 86, // Servicio MÃ­nimo
                antId: 73 // Anticipo (ID) que dejÃ³
            };

            // ANTICIPOS Indices
            const idxAnt = {
                key: 0, // Folio##Anticipo
                label: 1, // Folio Anticipo
                fecha: 2,
                monto: 42, // O 39, 47. Usaremos 39 (Total) o 42. En sample 39=1200, 42=500. 500 es el anticipo.
                refRec: 77 // Folio RecepciÃ³n
            };
            // Dynamic check for Amount in Anticipos
            const idxAntMontoHeaders = getIndex(hAnt, 'Cantidad Anticipo');
            if (idxAntMontoHeaders > -1) idxAnt.monto = idxAntMontoHeaders;

            // VENTAS Indices
            const idxVen = {
                key: 1, // Folio##Venta
                label: 2, // Folio Venta
                fecha: 3,
                ingreso: 44, // Total Venta (Based on analysis)
                folioRecVisible: 5, // Folio RecepciÃ³n Final (Visible Label)
                datosAnt: 136, // Datos##Anticipo (Key Link)
                folioRecKey: 132 // Estimated Key Link. Let's try to find it dynamically.
            };
            // Try to find hidden keys dynamically if possible, else stick to analysis
            const findKeyRec = getIndex(hVen, 'FOLIO##RECEPCIÃ“N');
            if (findKeyRec > -1) idxVen.folioRecKey = findKeyRec;

            // EGRESOS Indices
            const idxEgr = {
                folio: 1,
                fecha: 6,
                tipo: 8,
                subtipo: 9,
                monto: 67,
                refAnt: 10,
                refRec: 12
            };

            // 2. PROCESS ARRAYS (Skip header row)

            // --- ANTICIPOS ---
            GLOBAL_DATA.anticipos = rawAnt.slice(1).map(row => {
                return {
                    key: row[idxAnt.key],
                    label: row[idxAnt.label],
                    fecha: row[idxAnt.fecha],
                    monto: cleanMoney(row[idxAnt.monto]),
                    refRecLabel: row[idxAnt.refRec],
                    raw: row
                };
            }).filter(i => i.key && i.key.startsWith('##'));

            GLOBAL_DATA.mapAnticipos = GLOBAL_DATA.anticipos.reduce((acc, item) => {
                acc[item.key] = item;
                return acc;
            }, {});

            // --- RECEPCIONES ---
            GLOBAL_DATA.recepciones = rawRec.slice(1).map(row => {
                // Link to Anticipo
                const antKey = row[idxRec.antId];
                const antObj = GLOBAL_DATA.mapAnticipos[antKey];

                return {
                    key: row[idxRec.key],
                    label: row[idxRec.label],
                    fecha: row[idxRec.fecha],
                    tipo: row[idxRec.tipo],
                    marca: row[idxRec.marca],
                    modelo: row[idxRec.modelo],
                    monto: cleanMoney(row[idxRec.monto]),
                    refAntLabel: antObj ? antObj.label : '-',
                    raw: row
                };
            }).filter(i => i.key && i.key.startsWith('##'));

            GLOBAL_DATA.mapRecepciones = GLOBAL_DATA.recepciones.reduce((acc, item) => {
                acc[item.key] = item;
                return acc;
            }, {});

            // --- EGRESOS ---
            GLOBAL_DATA.egresos = rawEgr.slice(1).map(row => ({
                folio: row[idxEgr.folio],
                fecha: row[idxEgr.fecha],
                tipo: row[idxEgr.tipo],
                subtipo: row[idxEgr.subtipo],
                monto: cleanMoney(row[idxEgr.monto]),
                refAnt: row[idxEgr.refAnt],
                refRec: row[idxEgr.refRec]
            })).filter(e => e.monto > 0); // Solo egresos reales

            // --- VENTAS ---
            GLOBAL_DATA.ventas = rawVen.slice(1).map(row => {
                const ingreso = cleanMoney(row[idxVen.ingreso]);
                
                // Linking
                const antKey = row[idxVen.datosAnt];
                const antObj = GLOBAL_DATA.mapAnticipos[antKey];

                const recKey = row[idxVen.folioRecKey]; // Hidden Key
                const recVisible = row[idxVen.folioRecVisible]; // Visible Label
                // Note: The visible label is preferred by user, but for deep linking we'd use the key.

                // Calculo de Costo (Egresos vinculados)
                // Buscamos Egresos que coincidan con la Recepcion o Anticipo vinculados
                const costos = GLOBAL_DATA.egresos.filter(e => {
                    const matchRec = (recKey && e.refRec === recKey);
                    const matchAnt = (antKey && e.refAnt === antKey);
                    return (e.tipo === 'Compra') && (matchRec || matchAnt);
                });
                
                const costoTotal = costos.reduce((sum, e) => sum + e.monto, 0);

                return {
                    key: row[idxVen.key],
                    label: row[idxVen.label],
                    fecha: row[idxVen.fecha],
                    ingreso: ingreso,
                    costo: costoTotal,
                    utilidad: ingreso - costoTotal,
                    refAntLabel: antObj ? antObj.label : '-',
                    refRecLabel: recVisible || '-',
                    raw: row
                };
            }).filter(v => v.key && v.key.startsWith('##'));

            renderDashboard();
        }

        // --- RENDER ---
        function renderDashboard() {
            renderVentas();
            renderRecepciones();
            renderAnticipos();
            renderEgresos();
        }

        // Helper para filtrar por fecha
        function filterByDate(data, dateField) {
            const periodo = document.getElementById('filter-periodo').value;
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            return data.filter(item => {
                const date = parseDate(item[dateField]);
                if (!date) return false;

                if (periodo === 'este-mes') {
                    return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
                } else if (periodo === 'mes-anterior') {
                    const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
                    const year = currentMonth === 0 ? currentYear - 1 : currentYear;
                    return date.getMonth() === lastMonth && date.getFullYear() === year;
                } else if (periodo === 'este-ano') {
                    return date.getFullYear() === currentYear;
                }
                return true;
            });
        }

        function calculateDistribution(data, fieldAccessor) {
            const counts = {};
            data.forEach(item => {
                const val = (fieldAccessor(item) || 'N/A').toString().toUpperCase();
                counts[val] = (counts[val] || 0) + 1;
            });
            // Convert to array and sort
            return Object.entries(counts)
                .map(([label, value]) => ({ label, value }))
                .sort((a, b) => b.value - a.value)
                .slice(0, 5); // Top 5
        }

        function renderBarChart(containerId, title, data, colorClass) {
            const container = document.getElementById(containerId);
            if (!data || data.length === 0) return;
            
            const maxVal = Math.max(...data.map(d => d.value));
            
            const bars = data.map(d => {
                const pct = (d.value / maxVal) * 100;
                return `
                    <div class="flex items-center gap-2 mb-1">
                        <div class="w-16 text-[9px] text-[#979797] truncate text-right">${d.label}</div>
                        <div class="flex-1 h-2 bg-[#979797]/10 rounded-full overflow-hidden">
                            <div class="h-full ${colorClass}" style="width: ${pct}%"></div>
                        </div>
                        <div class="w-6 text-[9px] font-bold text-white">${d.value}</div>
                    </div>
                `;
            }).join('');

            container.innerHTML += `
                <div class="bg-[#060c0e] border border-[#979797]/20 p-3 rounded-lg">
                    <p class="text-[10px] font-bold text-white mb-2 border-b border-[#979797]/10 pb-1">${title}</p>
                    ${bars}
                </div>
            `;
        }

        function renderVentas() {
            const filtered = filterByDate(GLOBAL_DATA.ventas, 'fecha');
            const totalIngreso = filtered.reduce((sum, v) => sum + v.ingreso, 0);
            
            document.getElementById('kpi-ventas-total').textContent = formatMoney(totalIngreso);

            // Table
            const tbody = document.querySelector('#table-ventas tbody');
            tbody.innerHTML = filtered.slice(0, 50).map(v => `
                <tr>
                    <td class="text-[#ea412c] font-bold">${v.label}</td>
                    <td>${v.fecha}</td>
                    <td class="text-right font-mono">${formatMoney(v.ingreso)}</td>
                    <td class="text-right font-mono text-[#979797]">${formatMoney(v.costo)}</td>
                    <td class="text-right font-bold ${v.utilidad >= 0 ? 'text-green-500' : 'text-red-500'}">${formatMoney(v.utilidad)}</td>
                    <td class="text-xs text-yellow-500">${v.refAntLabel !== '-' ? v.refAntLabel : ''}</td>
                    <td class="text-xs text-blue-400">${v.refRecLabel !== '-' ? v.refRecLabel : ''}</td>
                </tr>
            `).join('');

            // Charts
            const chartContainer = document.getElementById('charts-ventas-dynamic');
            chartContainer.innerHTML = '';
            // Distribucion por fecha (DÃ­a)
            const distDia = calculateDistribution(filtered, v => v.fecha.split('/')[0]); // Asumiendo DD/MM/YYYY
            renderBarChart('charts-ventas-dynamic', 'Ventas por DÃ­a', distDia, 'bg-[#ea412c]');
            // Top Utilidad (dummy check)
            const distUtil = filtered.sort((a,b) => b.utilidad - a.utilidad).slice(0,5).map(v => ({label: v.label, value: v.utilidad}));
            renderBarChart('charts-ventas-dynamic', 'Top Utilidad', distUtil, 'bg-green-500');
        }

        function renderRecepciones() {
            // No filtramos por fecha por defecto o sÃ­? User said "Dashboard features...".
            // Aplicaremos el mismo filtro global por ahora para consistencia visual.
            const filtered = filterByDate(GLOBAL_DATA.recepciones, 'fecha');
            document.getElementById('kpi-recepcion-count').textContent = filtered.length;

            const tbody = document.querySelector('#table-recepcion tbody');
            tbody.innerHTML = filtered.slice(0, 50).map(r => `
                <tr>
                    <td class="text-blue-400 font-bold">${r.label}</td>
                    <td>${r.fecha}</td>
                    <td>${r.tipo || '-'}</td>
                    <td>${r.marca} ${r.modelo}</td>
                    <td class="text-right font-mono">${formatMoney(r.monto)}</td>
                    <td class="text-yellow-500 text-xs">${r.refAntLabel}</td>
                </tr>
            `).join('');

            // Charts
            const chartContainer = document.getElementById('charts-recepcion-dynamic');
            chartContainer.innerHTML = '';
            renderBarChart('charts-recepcion-dynamic', 'Tipo Solicitud', calculateDistribution(filtered, r => r.tipo), 'bg-blue-500');
            renderBarChart('charts-recepcion-dynamic', 'Marca', calculateDistribution(filtered, r => r.marca), 'bg-blue-400');
        }

        function renderAnticipos() {
            const filtered = filterByDate(GLOBAL_DATA.anticipos, 'fecha');
            const total = filtered.reduce((s, a) => s + a.monto, 0);
            document.getElementById('kpi-anticipos-total').textContent = formatMoney(total);

            const tbody = document.querySelector('#table-anticipos tbody');
            tbody.innerHTML = filtered.slice(0, 50).map(a => `
                <tr>
                    <td class="text-yellow-400 font-bold">${a.label}</td>
                    <td>${a.fecha}</td>
                    <td class="text-right font-mono text-white font-bold">${formatMoney(a.monto)}</td>
                    <td class="text-blue-400 text-xs">${a.refRecLabel || '-'}</td>
                </tr>
            `).join('');

             const chartContainer = document.getElementById('charts-anticipos-dynamic');
            chartContainer.innerHTML = '';
             renderBarChart('charts-anticipos-dynamic', 'Top Montos', filtered.sort((a,b)=>b.monto-a.monto).slice(0,5).map(x=>({label:x.label, value:x.monto})), 'bg-yellow-500');
        }

        function renderEgresos() {
            const filtered = filterByDate(GLOBAL_DATA.egresos, 'fecha');
            const total = filtered.reduce((s, e) => s + e.monto, 0);
            document.getElementById('kpi-egresos-total').textContent = formatMoney(total);

            const tbody = document.querySelector('#table-egresos tbody');
            tbody.innerHTML = filtered.slice(0, 50).map(e => `
                <tr>
                    <td class="text-[#ea412c] font-bold">${e.folio || '-'}</td>
                    <td>${e.fecha}</td>
                    <td class="uppercase text-[10px] font-bold">${e.tipo}</td>
                    <td class="text-[#979797] text-[10px]">${e.subtipo || '-'}</td>
                    <td class="font-mono text-right text-[#ea412c]">${formatMoney(e.monto)}</td>
                    <td class="text-[10px] font-mono">${e.refRec || e.refAnt || ''}</td>
                </tr>
            `).join('');

            const chartContainer = document.getElementById('charts-egresos-dynamic');
            chartContainer.innerHTML = '';
            renderBarChart('charts-egresos-dynamic', 'Por Tipo', calculateDistribution(filtered, e => e.tipo), 'bg-[#ea412c]');
            renderBarChart('charts-egresos-dynamic', 'Por Subtipo', calculateDistribution(filtered, e => e.subtipo), 'bg-orange-500');
        }

        // --- UI UTILS ---
        function toggleSection(id) {
            const content = document.getElementById('content-' + id);
            const icon = document.getElementById('icon-' + id);
            if(content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                icon.style.transform = 'rotate(-90deg)';
            } else {
                content.classList.add('expanded');
                icon.style.transform = 'rotate(0deg)';
            }
        }
        function expandAll() { document.querySelectorAll('.collapsible-content').forEach(e => e.classList.add('expanded')); }
        function collapseAll() { document.querySelectorAll('.collapsible-content').forEach(e => e.classList.remove('expanded')); }

        // Start
        window.onload = loadAllData;
    </script>
</body>
</html>
