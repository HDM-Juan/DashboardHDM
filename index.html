<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital de M√≥vil - Quantum Management System</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PapaParse para leer Google Sheets -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <!-- Fuentes Corporativas -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@100..900&family=Orbitron:wght@400..900&display=swap');
        
        :root {
            --glass-bg: rgba(13, 17, 23, 0.85);
            --glass-border: rgba(255, 255, 255, 0.08);
            --metallic-dark: #0f172a;
            --metallic-light: #334155;
            --corporate-red: #dc2626; 
            --corporate-red-glow: rgba(220, 38, 38, 0.5);
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
        }

        body { 
            font-family: 'Montserrat', sans-serif;
            background-color: #020617;
            color: var(--text-main);
            background-image: 
                linear-gradient(rgba(2, 6, 23, 0.9), rgba(2, 6, 23, 0.95)),
                url('https://www.transparenttextures.com/patterns/carbon-fibre.png');
            background-attachment: fixed;
        }

        .font-cyber { font-family: 'Orbitron', sans-serif; }

        /* Efecto Glassmorphism Avanzado */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 0.75rem;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }

        /* Encabezados Met√°licos */
        .metallic-header {
            background: linear-gradient(180deg, var(--metallic-light) 0%, var(--metallic-dark) 100%);
            border-bottom: 3px solid var(--corporate-red);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }

        /* Animaciones de Colapso */
        .collapsible-content {
            transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.5s ease;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        .collapsible-content.expanded {
            max-height: 20000px;
            opacity: 1;
        }

        /* Tablas de Alta Densidad */
        table { border-collapse: separate; border-spacing: 0; width: 100%; }
        thead th { 
            background: rgba(30, 41, 59, 0.9);
            color: #cbd5e1;
            text-transform: uppercase;
            font-size: 0.65rem;
            font-weight: 700;
            letter-spacing: 0.05em;
            padding: 10px;
            border-bottom: 2px solid var(--metallic-light);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        tbody tr { background: rgba(255, 255, 255, 0.01); transition: all 0.2s; }
        tbody tr:hover { background: rgba(220, 38, 38, 0.15); transform: translateX(2px); }
        td { 
            padding: 8px 10px; 
            border-bottom: 1px solid rgba(255,255,255,0.03); 
            font-size: 0.7rem;
            white-space: nowrap;
        }

        /* Utilidades */
        .kpi-value { font-family: 'Orbitron', sans-serif; letter-spacing: -0.5px; }
        .text-glow { text-shadow: 0 0 10px var(--corporate-red-glow); }
        
        /* Botones personalizados */
        .btn-repo {
            background: #1f2937;
            border: 1px solid #374151;
            display: flex; align-items: center; gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.2s;
        }
        .btn-repo:hover { background: #374151; border-color: var(--corporate-red); color: white; }

        /* Loader */
        .loader-bar {
            height: 2px;
            width: 100%;
            background: linear-gradient(90deg, transparent, var(--corporate-red), transparent);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body class="min-h-screen">

    <!-- Navbar Corporativo -->
    <nav class="metallic-header sticky top-0 z-50 px-4 py-3 flex flex-wrap justify-between items-center">
        <div class="flex items-center space-x-4">
            <div class="relative group">
                <img src="https://i.imgur.com/6R6fPFf.gif" alt="Logo" class="w-12 h-12 rounded-full border-2 border-slate-500 shadow-lg group-hover:border-red-500 transition-colors">
                <div class="absolute inset-0 rounded-full bg-red-500/20 blur-md opacity-0 group-hover:opacity-100 transition-opacity"></div>
            </div>
            <div>
                <h1 class="text-xl font-black font-cyber text-white leading-none tracking-tight">
                    HOSPITAL <span class="text-red-500 text-glow">DE</span> M√ìVIL
                </h1>
                <p class="text-[0.6rem] text-slate-400 uppercase tracking-[0.2em] font-bold mt-1">Quantum Management System v3.0</p>
            </div>
        </div>
        
        <div class="flex items-center gap-3 mt-2 sm:mt-0">
            <!-- Link al Repositorio (Placeholder) -->
            <a href="https://github.com/tu-usuario/hospital-movil-dashboard" target="_blank" class="btn-repo group">
                <svg class="w-4 h-4 text-slate-400 group-hover:text-white" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"/></svg>
                <span>GitHub Repo</span>
            </a>
            <div class="h-6 w-px bg-slate-700"></div>
            <button onclick="expandAll()" class="btn-repo">Expandir</button>
            <button onclick="collapseAll()" class="btn-repo">Contraer</button>
            <button onclick="window.location.reload()" class="bg-red-700 hover:bg-red-600 text-white px-3 py-1 rounded text-xs uppercase font-bold shadow-lg shadow-red-900/50 transition-all border border-red-500">Sincronizar</button>
        </div>
    </nav>

    <div id="loading-bar" class="loader-bar fixed top-[60px] left-0 z-40 opacity-0 transition-opacity"></div>

    <main class="p-4 space-y-6 max-w-[1800px] mx-auto pb-20">

        <!-- 1. VENTAS / FINANZAS (Verde) -->
        <section class="glass border-l-4 border-emerald-500 overflow-hidden relative group">
            <div id="bg-ventas" class="absolute inset-0 opacity-[0.08] bg-cover bg-center pointer-events-none grayscale group-hover:grayscale-0 transition-all duration-1000"></div>
            
            <div class="p-5 cursor-pointer hover:bg-white/5 transition-colors flex justify-between items-center" onclick="toggleSection('ventas')">
                <div class="flex items-center gap-4">
                    <div class="bg-emerald-900/30 p-2 rounded-lg border border-emerald-500/30">
                        <span class="text-2xl">üìó</span>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-emerald-400 font-cyber tracking-wide">VENTAS Y UTILIDAD</h2>
                        <p class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Flujo de Ingresos vs Egresos Relacionados</p>
                    </div>
                </div>
                <div class="flex items-center gap-6">
                    <div class="text-right hidden md:block">
                        <p class="text-[9px] text-gray-500 uppercase font-bold">Total Ingreso (Venta Mes)</p>
                        <p id="kpi-ventas-total" class="text-emerald-400 font-bold kpi-value text-xl">$0.00</p>
                    </div>
                    <div class="text-right hidden md:block border-l border-white/10 pl-4">
                        <p class="text-[9px] text-gray-500 uppercase font-bold">Utilidad Bruta Calc.</p>
                        <p id="kpi-ventas-utilidad" class="text-white font-bold kpi-value text-xl">$0.00</p>
                    </div>
                    <span id="icon-ventas" class="text-gray-500 transform -rotate-90 transition-transform duration-300">‚ñº</span>
                </div>
            </div>

            <div id="content-ventas" class="collapsible-content border-t border-white/5">
                <div class="p-4 space-y-4 bg-slate-900/40 backdrop-blur-sm">
                    <!-- Fila 1: Filtros B√°sicos -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="space-y-1">
                            <label class="text-[9px] text-emerald-500 font-bold uppercase tracking-wider">Filtro: Validez‚úÖ</label>
                            <select id="filter-ventas-validez" class="w-full bg-slate-800 text-xs border border-slate-600 rounded p-1.5 text-gray-300 focus:border-emerald-500 focus:ring-0 outline-none">
                                <option value="ALL">Todos los Estados</option>
                                <option value="V√°lido" selected>V√°lido</option>
                                <option value="Cancelado">Cancelado</option>
                            </select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[9px] text-emerald-500 font-bold uppercase tracking-wider">Filtro: Con Servicio</label>
                            <select class="w-full bg-slate-800 text-xs border border-slate-600 rounded p-1.5 text-gray-300 focus:border-emerald-500 focus:ring-0 outline-none">
                                <option>Todos</option>
                                <option>S√≠</option>
                            </select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[9px] text-emerald-500 font-bold uppercase tracking-wider">Costo Fijo Mensual ($)</label>
                            <input type="number" id="fixed-costs-input" value="10000" class="w-full bg-slate-800 text-xs border border-slate-600 rounded p-1.5 text-gray-300 focus:border-emerald-500 focus:ring-0 outline-none font-mono">
                        </div>
                        <div class="flex items-end">
                            <button onclick="window.updateDashboard()" class="w-full bg-gradient-to-r from-emerald-900 to-emerald-800 hover:from-emerald-800 hover:to-emerald-700 text-white border border-emerald-500/30 text-xs py-1.5 rounded uppercase font-bold tracking-wider shadow-lg transition-all">Actualizar M√©tricas</button>
                        </div>
                    </div>
                    
                    <!-- Fila 2: Controles Avanzados -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 pt-4 border-t border-emerald-500/20">
                        <!-- Per√≠odo a Analizar -->
                        <div class="space-y-1">
                            <label class="text-[9px] text-emerald-500 font-bold uppercase tracking-wider">üìä Per√≠odo a Analizar</label>
                            <select id="filter-periodo" class="w-full bg-slate-800 text-xs border border-slate-600 rounded p-1.5 text-gray-300 focus:border-emerald-500 focus:ring-0 outline-none">
                                <option value="este-mes" selected>Este Mes</option>
                                <option value="elegir-mes">Elegir Mes</option>
                                <option value="este-bimestre">Este Bimestre</option>
                                <option value="este-trimestre">Este Trimestre</option>
                                <option value="este-semestre">Este Semestre</option>
                                <option value="este-ano">Este A√±o</option>
                            </select>
                        </div>
                        
                        <!-- Selector de Mes/A√±o (visible cuando Elegir Mes est√° seleccionado) -->
                        <div id="selector-mes-ano" class="space-y-1 hidden">
                            <label class="text-[9px] text-emerald-500 font-bold uppercase tracking-wider">üìÖ Mes/A√±o</label>
                            <input type="month" id="input-mes-ano" class="w-full bg-slate-800 text-xs border border-slate-600 rounded p-1.5 text-gray-300 focus:border-emerald-500 focus:ring-0 outline-none">
                        </div>
                        
                        <!-- Agregaci√≥n -->
                        <div class="space-y-1">
                            <label class="text-[9px] text-emerald-500 font-bold uppercase tracking-wider">üìà Agregaci√≥n</label>
                            <select id="filter-agregacion" class="w-full bg-slate-800 text-xs border border-slate-600 rounded p-1.5 text-gray-300 focus:border-emerald-500 focus:ring-0 outline-none">
                                <option value="por-folio" selected>Por Folio</option>
                                <option value="por-dia">Por D√≠a</option>
                                <option value="por-semana">Por Semana</option>
                                <option value="por-mes">Por Mes</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Fila 3: Comparaci√≥n y M√©tricas -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t border-emerald-500/20">
                        <!-- Comparaci√≥n -->
                        <div class="space-y-2">
                            <label class="text-[9px] text-emerald-500 font-bold uppercase tracking-wider">üîÑ Comparaci√≥n</label>
                            <div class="space-y-1.5">
                                <label class="flex items-center gap-2 text-xs text-gray-300 cursor-pointer hover:text-emerald-400 transition-colors">
                                    <input type="checkbox" id="comp-sin-comparar" class="comparison-checkbox w-3.5 h-3.5 bg-slate-800 border border-slate-600 rounded focus:ring-0 focus:ring-offset-0 text-emerald-500" checked>
                                    <span>Sin Comparar</span>
                                </label>
                                <label class="flex items-center gap-2 text-xs text-gray-300 cursor-pointer hover:text-emerald-400 transition-colors">
                                    <input type="checkbox" id="comp-periodo-anterior" class="comparison-checkbox w-3.5 h-3.5 bg-slate-800 border border-slate-600 rounded focus:ring-0 focus:ring-offset-0 text-emerald-500">
                                    <span>Per√≠odo Anterior</span>
                                </label>
                                <label class="flex items-center gap-2 text-xs text-gray-300 cursor-pointer hover:text-emerald-400 transition-colors">
                                    <input type="checkbox" id="comp-segundo-anterior" class="comparison-checkbox w-3.5 h-3.5 bg-slate-800 border border-slate-600 rounded focus:ring-0 focus:ring-offset-0 text-emerald-500">
                                    <span>Segundo Per√≠odo Anterior</span>
                                </label>
                                <label class="flex items-center gap-2 text-xs text-gray-300 cursor-pointer hover:text-emerald-400 transition-colors">
                                    <input type="checkbox" id="comp-ano-anterior" class="comparison-checkbox w-3.5 h-3.5 bg-slate-800 border border-slate-600 rounded focus:ring-0 focus:ring-offset-0 text-emerald-500">
                                    <span>Mismo Per√≠odo del A√±o Anterior</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- M√©tricas a Mostrar -->
                        <div class="space-y-2">
                            <label class="text-[9px] text-emerald-500 font-bold uppercase tracking-wider">üìä M√©tricas a Mostrar</label>
                            <div class="grid grid-cols-2 gap-1.5">
                                <label class="flex items-center gap-2 text-xs text-gray-300 cursor-pointer hover:text-emerald-400 transition-colors">
                                    <input type="checkbox" id="metric-ingreso" class="w-3.5 h-3.5 bg-slate-800 border border-slate-600 rounded focus:ring-0 focus:ring-offset-0 text-emerald-500" checked>
                                    <span>Ingreso (Total Ventas)</span>
                                </label>
                                <label class="flex items-center gap-2 text-xs text-gray-300 cursor-pointer hover:text-emerald-400 transition-colors">
                                    <input type="checkbox" id="metric-flujo" class="w-3.5 h-3.5 bg-slate-800 border border-slate-600 rounded focus:ring-0 focus:ring-offset-0 text-emerald-500">
                                    <span>Flujo (Total Pagos)</span>
                                </label>
                                <label class="flex items-center gap-2 text-xs text-gray-300 cursor-pointer hover:text-emerald-400 transition-colors">
                                    <input type="checkbox" id="metric-costo-ventas" class="w-3.5 h-3.5 bg-slate-800 border border-slate-600 rounded focus:ring-0 focus:ring-offset-0 text-emerald-500">
                                    <span>Costo de Ventas</span>
                                </label>
                                <label class="flex items-center gap-2 text-xs text-gray-300 cursor-pointer hover:text-emerald-400 transition-colors">
                                    <input type="checkbox" id="metric-gastos" class="w-3.5 h-3.5 bg-slate-800 border border-slate-600 rounded focus:ring-0 focus:ring-offset-0 text-emerald-500">
                                    <span>Gastos (Gastos/Pagos)</span>
                                </label>
                                <label class="flex items-center gap-2 text-xs text-gray-300 cursor-pointer hover:text-emerald-400 transition-colors">
                                    <input type="checkbox" id="metric-utilidad-bruta" class="w-3.5 h-3.5 bg-slate-800 border border-slate-600 rounded focus:ring-0 focus:ring-offset-0 text-emerald-500" checked>
                                    <span>Utilidad Bruta</span>
                                </label>
                                <label class="flex items-center gap-2 text-xs text-gray-300 cursor-pointer hover:text-emerald-400 transition-colors">
                                    <input type="checkbox" id="metric-utilidad-admin" class="w-3.5 h-3.5 bg-slate-800 border border-slate-600 rounded focus:ring-0 focus:ring-offset-0 text-emerald-500">
                                    <span>Utilidad Administrativa</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-6 space-y-6">
                    <div class="relative">
                        <div class="absolute top-0 left-0 bg-emerald-500/10 text-emerald-400 text-[10px] font-bold px-2 py-1 rounded-br border-b border-r border-emerald-500/20">FLUJO FINANCIERO</div>
                        <div id="chart-ventas-main" class="h-72 bg-slate-800/30 rounded-lg border border-white/5 flex items-center justify-center relative overflow-hidden">
                            <p class="text-emerald-500/30 font-cyber text-xs animate-pulse">Iniciando protocolo de visualizaci√≥n...</p>
                        </div>
                    </div>
                    <div id="charts-ventas-dynamic" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"></div>
                    <div class="overflow-x-auto rounded-lg border border-white/10 shadow-2xl">
                        <table id="table-ventas">
                            <thead>
                                <tr>
                                    <th>üìó Folio Venta</th>
                                    <th>üìÖFecha Venta</th>
                                    <th>Total Venta (Ingreso)</th>
                                    <th>Costo Calc. (Egresos)</th>
                                    <th>Utilidad Bruta</th>
                                    <th>Ref Recepci√≥n/Anticipo</th>
                                    <th>Dispositivo (Ref)</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-white/5"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- 2. RECEPCI√ìN (Azul) -->
        <section class="glass border-l-4 border-blue-500 overflow-hidden relative group">
            <div id="bg-recepcion" class="absolute inset-0 opacity-[0.08] bg-cover bg-center pointer-events-none grayscale group-hover:grayscale-0 transition-all duration-1000"></div>
            
            <div class="p-5 cursor-pointer hover:bg-white/5 transition-colors flex justify-between items-center" onclick="toggleSection('recepcion')">
                <div class="flex items-center gap-4">
                    <div class="bg-blue-900/30 p-2 rounded-lg border border-blue-500/30">
                        <span class="text-2xl">üìò</span>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-blue-400 font-cyber tracking-wide">FORMATOS DE RECEPCI√ìN</h2>
                        <p class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Servicios T√©cnicos y Diagn√≥sticos</p>
                    </div>
                </div>
                <div class="flex items-center gap-6">
                    <button class="hidden sm:flex items-center gap-1 bg-blue-500/10 hover:bg-blue-500/20 text-blue-400 px-2 py-1 rounded border border-blue-500/30 text-[10px] font-bold uppercase transition-all" onclick="event.stopPropagation(); syncFilters('ventas', 'recepcion')">
                        <span>‚ö°</span> Heredar Filtros Venta
                    </button>
                    <div class="text-right hidden sm:block">
                        <p class="text-[9px] text-gray-500 uppercase font-bold">Folios Filtrados</p>
                        <p id="kpi-recepcion-count" class="text-blue-400 font-bold kpi-value text-xl">0</p>
                    </div>
                    <span id="icon-recepcion" class="text-gray-500 transform -rotate-90 transition-transform duration-300">‚ñº</span>
                </div>
            </div>

            <div id="content-recepcion" class="collapsible-content border-t border-white/5">
                <div class="p-4 grid grid-cols-1 md:grid-cols-5 gap-4 bg-slate-900/40 backdrop-blur-sm">
                    <div class="space-y-1">
                        <label class="text-[9px] text-blue-500 font-bold uppercase tracking-wider">Validez‚úÖ</label>
                        <select id="filter-recepcion-validez" class="w-full bg-slate-800 text-xs border border-slate-600 rounded p-1.5 text-gray-300"><option value="V√°lido" selected>V√°lido</option><option value="ALL">Todos</option></select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[9px] text-blue-500 font-bold uppercase tracking-wider">EstatusüîÑÔ∏è</label>
                        <select class="w-full bg-slate-800 text-xs border border-slate-600 rounded p-1.5 text-gray-300"><option>Todos</option></select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[9px] text-blue-500 font-bold uppercase tracking-wider">Vigencia‚åõ</label>
                        <select class="w-full bg-slate-800 text-xs border border-slate-600 rounded p-1.5 text-gray-300"><option>Todas</option></select>
                    </div>
                </div>

                <div class="p-6 space-y-6">
                    <div class="relative">
                        <div class="absolute top-0 left-0 bg-blue-500/10 text-blue-400 text-[10px] font-bold px-2 py-1 rounded-br border-b border-r border-blue-500/20">ACUMULACI√ìN DIARIA</div>
                        <div id="chart-recepcion-main" class="h-48 bg-slate-800/30 rounded-lg border border-white/5 flex items-center justify-center">
                            <p class="text-blue-500/30 font-cyber text-xs">Visualizaci√≥n de Servicios...</p>
                        </div>
                    </div>
                    <div id="charts-recepcion-dynamic" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"></div>
                    <div class="overflow-x-auto rounded-lg border border-white/10 shadow-2xl">
                        <table id="table-recepcion">
                            <thead>
                                <tr>
                                    <th>üìò Folio Recepci√≥n</th>
                                    <th>üìÖFecha Recepci√≥n</th>
                                    <th>1Ô∏è‚É£ Tipo Solicitud</th>
                                    <th>¬ÆÔ∏è Marca / üì± Modelo</th>
                                    <th>‚öôÔ∏è Tipo Servicio</th>
                                    <th>üí≤ Serv. M√≠nimo</th>
                                    <th>üí° Enciende</th>
                                    <th>üíß Mojado</th>
                                    <th>üìí Ant. Vinculado</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-white/5"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- 3. ANTICIPOS (Amarillo) -->
        <section class="glass border-l-4 border-yellow-500 overflow-hidden relative group">
            <div id="bg-anticipos" class="absolute inset-0 opacity-[0.08] bg-cover bg-center pointer-events-none grayscale group-hover:grayscale-0 transition-all duration-1000"></div>
            
            <div class="p-5 cursor-pointer hover:bg-white/5 transition-colors flex justify-between items-center" onclick="toggleSection('anticipos')">
                <div class="flex items-center gap-4">
                    <div class="bg-yellow-900/30 p-2 rounded-lg border border-yellow-500/30">
                        <span class="text-2xl">üìí</span>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-yellow-400 font-cyber tracking-wide">ANTICIPOS</h2>
                        <p class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Gesti√≥n de Pagos Parciales</p>
                    </div>
                </div>
                <div class="flex items-center gap-6">
                    <div class="text-right hidden md:block">
                        <p class="text-[9px] text-gray-500 uppercase font-bold">Total Acumulado</p>
                        <p id="kpi-anticipos-total" class="text-yellow-400 font-bold kpi-value text-xl">$0.00</p>
                    </div>
                    <span id="icon-anticipos" class="text-gray-500 transform -rotate-90 transition-transform duration-300">‚ñº</span>
                </div>
            </div>

            <div id="content-anticipos" class="collapsible-content border-t border-white/5">
                <div class="p-6 space-y-6">
                    <div id="charts-anticipos-dynamic" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"></div>
                    
                    <div class="overflow-x-auto rounded-lg border border-white/10 shadow-2xl">
                        <table id="table-anticipos">
                            <thead>
                                <tr>
                                    <th>üìí Folio Anticipo</th>
                                    <th>üìÖFecha Anticipo</th>
                                    <th>Monto</th>
                                    <th>üìò Ref Recepci√≥n</th>
                                    <th>Dispositivo (Ref)</th>
                                    <th>Estatus</th>
                                    <th>Vigencia</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-white/5"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- 4. EGRESOS / COMPRAS (Rojo) -->
        <section class="glass border-l-4 border-red-600 overflow-hidden relative group">
            <div id="bg-egresos" class="absolute inset-0 opacity-[0.08] bg-cover bg-center pointer-events-none grayscale group-hover:grayscale-0 transition-all duration-1000"></div>
            
            <div class="p-5 cursor-pointer hover:bg-white/5 transition-colors flex justify-between items-center" onclick="toggleSection('egresos')">
                <div class="flex items-center gap-4">
                    <div class="bg-red-900/30 p-2 rounded-lg border border-red-500/30">
                        <span class="text-2xl">üìï</span>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-red-500 font-cyber tracking-wide">EGRESOS Y COMPRAS</h2>
                        <p class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Compras de Refacciones y Gastos</p>
                    </div>
                </div>
                <div class="flex items-center gap-6">
                    <div class="text-right hidden md:block">
                        <p class="text-[9px] text-gray-500 uppercase font-bold">Total Salidas</p>
                        <p id="kpi-egresos-total" class="text-red-400 font-bold kpi-value text-xl">$0.00</p>
                    </div>
                    <span id="icon-egresos" class="text-gray-500 transform -rotate-90 transition-transform duration-300">‚ñº</span>
                </div>
            </div>

            <div id="content-egresos" class="collapsible-content border-t border-white/5">
                <div class="p-4 grid grid-cols-1 md:grid-cols-4 gap-4 bg-slate-900/40 backdrop-blur-sm">
                    <div class="space-y-1">
                        <label class="text-[9px] text-red-500 font-bold uppercase tracking-wider">Filtro: Tipo</label>
                        <select id="filter-egresos-tipo" class="w-full bg-slate-800 text-xs border border-slate-600 rounded p-1.5 text-gray-300 font-medium"><option value="ALL">Todos (Compra/Gasto)</option><option value="Compra">Compra</option><option value="Gasto/Pago">Gasto/Pago</option></select>
                    </div>
                </div>

                <div class="p-6 space-y-6">
                    <div id="charts-egresos-dynamic" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"></div>
                    <div class="overflow-x-auto rounded-lg border border-white/10 shadow-2xl">
                        <table id="table-egresos">
                            <thead>
                                <tr>
                                    <th>üìï Folio</th>
                                    <th>Fecha</th>
                                    <th>Tipo</th>
                                    <th>Subtipo</th>
                                    <th>Monto</th>
                                    <th>Proveedor</th>
                                    <th>Ref Vinculada (Rec/Ant)</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-white/5"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- Scripts de L√≥gica (GOOGLE SHEETS EDITION) -->
    <script>
        // ID de la hoja de c√°lculo
        const SHEET_ID = '1wci9zwPk8EUMW8RrWsZQpPToOYso8NXxZXBMbWyxK94';
        
        // URLs construidas para la API de visualizaci√≥n de Google
        const SHEET_URLS = {
            // Nota: %20 reemplaza los espacios en el nombre de la hoja
            RECEPCIONES: `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Respuestas%20a%20formulario%206`,
            VENTAS: `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Ventas_ZR`,
            ANTICIPOS: `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Anticipos_ZR`,
            EGRESOS: `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Egresos`
        };

        // Estado Global
        let GLOBAL_DATA = {
            recepciones: [],
            ventas: [],
            anticipos: [],
            egresos: []
        };

        // --- UTILS ---
        const cleanMoney = (val) => {
            if (!val) return 0;
            if (typeof val === 'number') return val;
            return parseFloat(val.toString().replace(/[$,\s]/g, '')) || 0;
        };

        const formatDate = (val) => val || '-';

        const formatMoney = (amount) => {
            return '$' + amount.toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };

        // --- CARGA DE DATOS (CSV) ---
        function loadAllData() {
            document.getElementById('loading-bar').style.opacity = '1';
            
            // Usamos Promise.all para cargar todos los CSV en paralelo
            Promise.all([
                fetchCsv(SHEET_URLS.RECEPCIONES),
                fetchCsv(SHEET_URLS.VENTAS),
                fetchCsv(SHEET_URLS.ANTICIPOS),
                fetchCsv(SHEET_URLS.EGRESOS)
            ]).then(([recData, venData, antData, egrData]) => {
                console.log("Datos CSV cargados:", recData.length, venData.length, antData.length, egrData.length);
                processData(recData, venData, antData, egrData);
                document.getElementById('loading-bar').style.opacity = '0';
            }).catch(error => {
                console.error("Error cargando CSVs:", error);
                document.getElementById('loading-bar').style.backgroundColor = 'red';
                alert("Error al cargar datos. Verifique que la hoja de Google Sheets est√© publicada en la web (Archivo > Compartir > Publicar en la web).");
            });
        }

        // Helper para fetch y parseo de CSV
        function fetchCsv(url) {
            return new Promise((resolve, reject) => {
                Papa.parse(url, {
                    download: true,
                    header: true, // Usa la primera fila como encabezados
                    complete: (results) => resolve(results.data),
                    error: (error) => reject(error)
                });
            });
        }

        function processData(rawRec, rawVen, rawAnt, rawEgr) {
            // 1. Crear Mapas para B√∫squeda R√°pida
            const recMap = rawRec.reduce((acc, item) => {
                if(item['Folio##Recepci√≥n']) acc[item['Folio##Recepci√≥n']] = item;
                return acc;
            }, {});

            const antMap = rawAnt.reduce((acc, item) => {
                if(item['Folio##Anticipo']) acc[item['Folio##Anticipo']] = item;
                return acc;
            }, {});

            // 2. Procesar EGRESOS
            GLOBAL_DATA.egresos = rawEgr.map(e => ({
                ...e,
                folio: e['Folio Egreso'] || 'S/N',
                tipo: e['Tipo'],
                subtipo: e['Subtipo'],
                monto: cleanMoney(e['Monto']),
                fecha: e['Fecha Orden Compra'] || e['Hora de Registro'],
                ref_rec: e['##Recepci√≥n'],
                ref_ant: e['##Anticipo'],
                validez: e['Validez'],
                proveedor: e['Proveedor']
            }));

            // 3. Procesar RECEPCIONES
            GLOBAL_DATA.recepciones = rawRec.map(r => {
                const antVinculado = antMap[r['Anticipo (ID) que dej√≥']];
                return {
                    ...r,
                    folio: r['Folio Recepci√≥n'],
                    fecha: r['Fecha Recepci√≥n'],
                    monto: cleanMoney(r['Servicio M√≠nimo']),
                    tipo_sol: r['1Ô∏è‚É£Tipo Solicitud'],
                    marca_modelo: `${r['¬ÆÔ∏èMarca'] || ''} ${r['üì±Modelo'] || ''}`,
                    tipo_serv: r['‚öôÔ∏èTipo Servicio'],
                    enciende: r['üí°Enciende'],
                    mojado: r['üíßMojado'],
                    ant_ref: r['Folio Anticipo'] || '-', 
                    validez: r['Validez']
                };
            });

            // 4. Procesar ANTICIPOS
            GLOBAL_DATA.anticipos = rawAnt.map(a => ({
                ...a,
                folio: a['Folio Anticipo'],
                fecha: a['Fecha Anticipo'],
                monto: cleanMoney(a['Cantidad Anticipo']),
                ref_rec_display: a['Folio Recepci√≥n'], 
                validez: a['Validez'],
                estatus: a['Estatus'],
                vigencia: a['Vigencia']
            }));

            // 5. Procesar VENTAS (C√°lculo de Utilidad)
            GLOBAL_DATA.ventas = rawVen.map(v => {
                const folioRecVenta = v['Folio##Recepci√≥n'];
                const folioAntVenta = v['Datos##Anticipo']; 
                const recData = recMap[folioRecVenta] || {};
                
                // Costo = Suma de Egresos vinculados
                const costosRelacionados = GLOBAL_DATA.egresos.filter(e => 
                    (e.tipo === 'Compra') && 
                    (
                        (folioRecVenta && e.ref_rec === folioRecVenta) ||
                        (folioAntVenta && e.ref_ant === folioAntVenta)
                    )
                );
                
                const costoTotal = costosRelacionados.reduce((sum, e) => sum + e.monto, 0);
                const ingresoTotal = cleanMoney(v['Total Venta']);

                return {
                    ...v,
                    folio: v['Folio Venta'],
                    fecha: v['Fecha ef-Venta'] || v['Fecha Venta'],
                    ingreso: ingresoTotal,
                    costo: costoTotal,
                    utilidad: ingresoTotal - costoTotal,
                    dispositivo_ref: recData['Dispositivo'] || 'N/A',
                    validez: v['Validez'],
                    folio_rec_vinculado: v['Folio Recepci√≥n Final']
                };
            });

            renderAll();
        }

        // --- ADVANCED FILTERS LOGIC ---
        
        // Toggle month selector visibility
        document.addEventListener('DOMContentLoaded', () => {
            const periodoSelect = document.getElementById('filter-periodo');
            const selectorMesAno = document.getElementById('selector-mes-ano');
            const inputMesAno = document.getElementById('input-mes-ano');
            
            // Set default month to current month
            const now = new Date();
            inputMesAno.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            
            periodoSelect.addEventListener('change', () => {
                if (periodoSelect.value === 'elegir-mes') {
                    selectorMesAno.classList.remove('hidden');
                } else {
                    selectorMesAno.classList.add('hidden');
                }
                updateAgregacionOptions();
            });
            
            // Comparison checkboxes logic
            const compCheckboxes = document.querySelectorAll('.comparison-checkbox');
            compCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', handleComparisonChange);
            });
            
            function handleComparisonChange(e) {
                const sinComparar = document.getElementById('comp-sin-comparar');
                if (e.target.id === 'comp-sin-comparar' && e.target.checked) {
                    compCheckboxes.forEach(cb => {
                        if (cb.id !== 'comp-sin-comparar') cb.checked = false;
                    });
                } else if (e.target.id !== 'comp-sin-comparar' && e.target.checked) {
                    sinComparar.checked = false;
                }
            }
            
            function updateAgregacionOptions() {
                const periodo = periodoSelect.value;
                const agregacionSelect = document.getElementById('filter-agregacion');
                const currentValue = agregacionSelect.value;
                
                // Clear options
                agregacionSelect.innerHTML = '';
                
                // Always available
                agregacionSelect.innerHTML += '<option value="por-folio">Por Folio</option>';
                agregacionSelect.innerHTML += '<option value="por-dia">Por D√≠a</option>';
                
                // Por Semana - solo para per√≠odo mensual o mayor
                if (['este-mes', 'elegir-mes', 'este-bimestre', 'este-trimestre', 'este-semestre', 'este-ano'].includes(periodo)) {
                    agregacionSelect.innerHTML += '<option value="por-semana">Por Semana</option>';
                }
                
                // Por Mes - solo para per√≠odo de a√±o
                if (periodo === 'este-ano') {
                    agregacionSelect.innerHTML += '<option value="por-mes">Por Mes</option>';
                }
                
                // Restore previous value if still available
                if (Array.from(agregacionSelect.options).some(opt => opt.value === currentValue)) {
                    agregacionSelect.value = currentValue;
                }
            }
            
            updateAgregacionOptions();
        });
        
        // Date range calculation helpers
        function getPeriodDates(periodo, customMonth = null) {
            const now = new Date();
            let startDate, endDate;
            
            switch(periodo) {
                case 'este-mes':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    break;
                case 'elegir-mes':
                    if (customMonth) {
                        const [year, month] = customMonth.split('-');
                        startDate = new Date(parseInt(year), parseInt(month) - 1, 1);
                        endDate = new Date(parseInt(year), parseInt(month), 0);
                    } else {
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    }
                    break;
                case 'este-bimestre':
                    const bimestreStart = Math.floor(now.getMonth() / 2) * 2;
                    startDate = new Date(now.getFullYear(), bimestreStart, 1);
                    endDate = new Date(now.getFullYear(), bimestreStart + 2, 0);
                    break;
                case 'este-trimestre':
                    const trimestreStart = Math.floor(now.getMonth() / 3) * 3;
                    startDate = new Date(now.getFullYear(), trimestreStart, 1);
                    endDate = new Date(now.getFullYear(), trimestreStart + 3, 0);
                    break;
                case 'este-semestre':
                    const semestreStart = now.getMonth() < 6 ? 0 : 6;
                    startDate = new Date(now.getFullYear(), semestreStart, 1);
                    endDate = new Date(now.getFullYear(), semestreStart + 6, 0);
                    break;
                case 'este-ano':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    endDate = new Date(now.getFullYear(), 12, 0);
                    break;
                default:
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            }
            
            return { startDate, endDate };
        }
        
        function getComparisonPeriods() {
            const periodo = document.getElementById('filter-periodo').value;
            const customMonth = document.getElementById('input-mes-ano').value;
            const { startDate, endDate } = getPeriodDates(periodo, customMonth);
            
            const periods = [{ startDate, endDate, label: 'Actual' }];
            
            if (document.getElementById('comp-periodo-anterior').checked) {
                const duration = endDate - startDate;
                const prevEnd = new Date(startDate.getTime() - 1);
                const prevStart = new Date(prevEnd.getTime() - duration + 1);
                periods.push({ startDate: prevStart, endDate: prevEnd, label: 'Per√≠odo Anterior' });
            }
            
            if (document.getElementById('comp-segundo-anterior').checked) {
                const duration = endDate - startDate;
                const prevEnd = new Date(startDate.getTime() - 1);
                const prev2End = new Date(prevEnd.getTime() - duration);
                const prev2Start = new Date(prev2End.getTime() - duration + 1);
                periods.push({ startDate: prev2Start, endDate: prev2End, label: 'Segundo Per√≠odo Anterior' });
            }
            
            if (document.getElementById('comp-ano-anterior').checked) {
                const prevYearStart = new Date(startDate);
                prevYearStart.setFullYear(prevYearStart.getFullYear() - 1);
                const prevYearEnd = new Date(endDate);
                prevYearEnd.setFullYear(prevYearEnd.getFullYear() - 1);
                periods.push({ startDate: prevYearStart, endDate: prevYearEnd, label: 'A√±o Anterior' });
            }
            
            return periods;
        }
        
        function parseDate(dateStr) {
            if (!dateStr) return null;
            // Try different date formats
            let date = new Date(dateStr);
            if (isNaN(date)) {
                // Try dd/mm/yyyy format
                const parts = dateStr.split('/');
                if (parts.length === 3) {
                    date = new Date(parts[2], parts[1] - 1, parts[0]);
                }
            }
            return isNaN(date) ? null : date;
        }
        
        function filterDataByPeriod(data, startDate, endDate) {
            return data.filter(item => {
                const itemDate = parseDate(item.fecha);
                if (!itemDate) return false;
                return itemDate >= startDate && itemDate <= endDate;
            });
        }
        
        function aggregateData(data, agregacion, startDate, endDate) {
            if (agregacion === 'por-folio') {
                return data; // No aggregation needed
            }
            
            const groups = {};
            
            data.forEach(item => {
                const itemDate = parseDate(item.fecha);
                if (!itemDate) return;
                
                let key;
                switch(agregacion) {
                    case 'por-dia':
                        key = itemDate.toISOString().split('T')[0];
                        break;
                    case 'por-semana':
                        const weekNum = getWeekNumber(itemDate);
                        key = `${itemDate.getFullYear()}-W${weekNum}`;
                        break;
                    case 'por-mes':
                        key = `${itemDate.getFullYear()}-${String(itemDate.getMonth() + 1).padStart(2, '0')}`;
                        break;
                    default:
                        key = itemDate.toISOString().split('T')[0];
                }
                
                if (!groups[key]) {
                    groups[key] = {
                        fecha: key,
                        ingreso: 0,
                        flujo: 0,
                        costo: 0,
                        count: 0,
                        items: []
                    };
                }
                
                groups[key].ingreso += item.ingreso || 0;
                groups[key].flujo += cleanMoney(item['Total Pagos'] || 0);
                groups[key].costo += item.costo || 0;
                groups[key].count += 1;
                groups[key].items.push(item);
            });
            
            return Object.values(groups);
        }
        
        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }
        
        function calculateMetrics(data, egresos, fixedCosts = 0) {
            const ingreso = data.reduce((s, v) => s + (v.ingreso || 0), 0);
            const flujo = data.reduce((s, v) => s + (cleanMoney(v['Total Pagos']) || 0), 0);
            const costoVentas = data.reduce((s, v) => s + (v.costo || 0), 0);
            
            // Calculate gastos from the period
            const gastos = egresos.filter(e => e.tipo === 'Gasto/Pago').reduce((s, e) => s + e.monto, 0);
            
            const utilidadBruta = ingreso - costoVentas;
            const utilidadAdmin = utilidadBruta - gastos - fixedCosts;
            
            return { ingreso, flujo, costoVentas, gastos, utilidadBruta, utilidadAdmin };
        }

        // --- RENDERIZADO DE INTERFAZ ---
        function renderAll() {
            renderVentas();
            renderRecepcion();
            renderAnticipos();
            renderEgresos();
            // generateThematicImages(); // Opcional si tienes API key
        }

        function renderVentas() {
            const validezFilter = document.getElementById('filter-ventas-validez')?.value || 'V√°lido';
            const fixedCosts = parseFloat(document.getElementById('fixed-costs-input')?.value || 0);
            
            // Get period and aggregation settings
            const periodo = document.getElementById('filter-periodo')?.value || 'este-mes';
            const agregacion = document.getElementById('filter-agregacion')?.value || 'por-folio';
            const customMonth = document.getElementById('input-mes-ano')?.value;
            
            // Get comparison periods
            const periods = getComparisonPeriods();
            const hasComparison = periods.length > 1;
            
            // Get selected metrics
            const showIngreso = document.getElementById('metric-ingreso')?.checked;
            const showFlujo = document.getElementById('metric-flujo')?.checked;
            const showCostoVentas = document.getElementById('metric-costo-ventas')?.checked;
            const showGastos = document.getElementById('metric-gastos')?.checked;
            const showUtilidadBruta = document.getElementById('metric-utilidad-bruta')?.checked;
            const showUtilidadAdmin = document.getElementById('metric-utilidad-admin')?.checked;
            
            // Filter by validez
            const allVentas = GLOBAL_DATA.ventas.filter(v => validezFilter === 'ALL' || v.validez === validezFilter);
            
            // Process each period
            const periodData = periods.map(period => {
                const filtered = filterDataByPeriod(allVentas, period.startDate, period.endDate);
                const egresos = filterDataByPeriod(GLOBAL_DATA.egresos, period.startDate, period.endDate);
                const aggregated = aggregateData(filtered, agregacion, period.startDate, period.endDate);
                const metrics = calculateMetrics(filtered, egresos, fixedCosts);
                
                return {
                    label: period.label,
                    data: aggregated,
                    filtered: filtered,
                    egresos: egresos,
                    metrics: metrics
                };
            });
            
            const currentPeriod = periodData[0];
            const totalVenta = currentPeriod.metrics.ingreso;
            const totalCostoVar = currentPeriod.metrics.costoVentas;
            const utilidadOperativa = currentPeriod.metrics.utilidadAdmin;
            
            // Update KPIs
            const kpiTotal = document.getElementById('kpi-ventas-total');
            const kpiUtil = document.getElementById('kpi-ventas-utilidad');
            if(kpiTotal) kpiTotal.textContent = formatMoney(totalVenta);
            if(kpiUtil) {
                kpiUtil.textContent = formatMoney(utilidadOperativa);
                kpiUtil.className = utilidadOperativa >= 0 ? "text-white font-bold kpi-value text-xl" : "text-red-500 font-bold kpi-value text-xl";
            }

            // Build chart HTML
            let chartHTML = '';
            
            if (hasComparison || agregacion !== 'por-folio') {
                // Multi-period or aggregated view - line/bar chart
                chartHTML = buildComparisonChart(periodData, showIngreso, showFlujo, showCostoVentas, showGastos, showUtilidadBruta, showUtilidadAdmin);
            } else {
                // Single period, no aggregation - show profit/loss visualization
                chartHTML = buildProfitLossChart(totalVenta, totalCostoVar, currentPeriod.metrics.gastos, fixedCosts, utilidadOperativa);
            }
            
            document.getElementById('chart-ventas-main').innerHTML = chartHTML;
            
            renderMiniCharts('charts-ventas-dynamic', ['Total Venta', 'Total Pagos', 'Dispositivo', 'Marca'], 'emerald');

            // Update table with current period data
            const tbody = document.querySelector('#table-ventas tbody');
            tbody.innerHTML = currentPeriod.filtered.slice(0, 100).map(v => `
                <tr>
                    <td class="text-emerald-400 font-bold">${v.folio || '-'}</td>
                    <td>${formatDate(v.fecha)}</td>
                    <td class="font-mono text-right">${formatMoney(v.ingreso)}</td>
                    <td class="font-mono text-right text-red-400">${formatMoney(v.costo)}</td>
                    <td class="font-mono text-right ${v.utilidad >= 0 ? 'text-green-400' : 'text-red-400'} font-bold">${formatMoney(v.utilidad)}</td>
                    <td class="text-gray-400 text-[10px]">${v.folio_rec_vinculado || '-'} / ${v['Datos##Anticipo'] || '-'}</td>
                    <td class="text-gray-300 text-[10px]">${v.dispositivo_ref}</td>
                </tr>
            `).join('');
        }
        
        function buildProfitLossChart(totalVenta, totalCostoVar, gastos, fixedCosts, utilidadOperativa) {
            const maxVal = Math.max(totalVenta, totalCostoVar + gastos + fixedCosts) * 1.1 || 100;
            const hIngreso = (totalVenta / maxVal) * 100;
            const hCostoVar = (totalCostoVar / maxVal) * 100;
            const hGastos = (gastos / maxVal) * 100;
            const hFijo = (fixedCosts / maxVal) * 100;
            
            // Determine if profit or loss
            const isProfitable = utilidadOperativa >= 0;
            const ingresoBarClass = isProfitable ? 'bg-emerald-500/80 border-emerald-400/30' : 'bg-red-500/80 border-red-400/30';
            const ingresoShadow = isProfitable ? 'rgba(16,185,129,0.4)' : 'rgba(239,68,68,0.4)';
            const ingresoTextClass = isProfitable ? 'text-emerald-400' : 'text-red-400';
            const utilidadBorderClass = isProfitable ? 'border-emerald-500/30' : 'border-red-500/30';
            
            return `
                <div class="relative w-full h-full p-6 flex items-end justify-center gap-12">
                    <div class="w-32 flex flex-col items-center group relative cursor-pointer">
                        <div class="w-full bg-red-600/80 rounded-t-sm shadow-[0_0_15px_rgba(220,38,38,0.4)] transition-all duration-1000 border-x border-t border-red-400/30" style="height: ${hFijo}%"></div>
                        <div class="w-full bg-orange-600/80 border-t border-white/20 transition-all duration-1000 shadow-[0_0_15px_rgba(234,88,12,0.4)]" style="height: ${hGastos}%"></div>
                        <div class="w-full bg-blue-600/80 border-t border-white/20 transition-all duration-1000 shadow-[0_0_15px_rgba(37,99,235,0.4)]" style="height: ${hCostoVar}%"></div>
                        <p class="mt-3 text-[10px] uppercase font-bold text-gray-400 tracking-widest">COSTOS</p>
                        <div class="absolute -bottom-6 text-xs font-bold text-red-400">${formatMoney(fixedCosts + gastos + totalCostoVar)}</div>
                    </div>
                    <div class="w-32 flex flex-col items-center group relative cursor-pointer">
                        <div class="w-full ${ingresoBarClass} rounded-t-sm shadow-[0_0_15px_${ingresoShadow}] transition-all duration-1000 border-x border-t" style="height: ${hIngreso}%"></div>
                        <p class="mt-3 text-[10px] uppercase font-bold text-gray-400 tracking-widest">INGRESOS</p>
                        <div class="absolute -bottom-6 text-xs font-bold ${ingresoTextClass}">${formatMoney(totalVenta)}</div>
                    </div>
                    <div class="absolute top-4 right-4 bg-slate-900/80 border ${utilidadBorderClass} rounded-lg px-3 py-2">
                        <p class="text-[9px] text-gray-400 uppercase tracking-wider">Utilidad ${isProfitable ? '‚úÖ' : '‚ö†Ô∏è'}</p>
                        <p class="text-lg font-bold ${ingresoTextClass} font-cyber">${formatMoney(utilidadOperativa)}</p>
                    </div>
                </div>
            `;
        }
        
        // Color mapping for metrics chart (constant)
        const METRIC_COLOR_CLASSES = {
            emerald: { bg: 'bg-emerald-500/70', border: 'border-emerald-400/30', text: 'text-emerald-400' },
            cyan: { bg: 'bg-cyan-500/70', border: 'border-cyan-400/30', text: 'text-cyan-400' },
            blue: { bg: 'bg-blue-500/70', border: 'border-blue-400/30', text: 'text-blue-400' },
            orange: { bg: 'bg-orange-500/70', border: 'border-orange-400/30', text: 'text-orange-400' },
            green: { bg: 'bg-green-500/70', border: 'border-green-400/30', text: 'text-green-400' },
            red: { bg: 'bg-red-500/70', border: 'border-red-400/30', text: 'text-red-400' }
        };
        
        function buildComparisonChart(periodData, showIngreso, showFlujo, showCostoVentas, showGastos, showUtilidadBruta, showUtilidadAdmin) {
            // Simple bar comparison chart
            const maxMetric = Math.max(...periodData.map(p => {
                return Math.max(
                    showIngreso ? p.metrics.ingreso : 0,
                    showFlujo ? p.metrics.flujo : 0,
                    showCostoVentas ? p.metrics.costoVentas : 0,
                    showGastos ? p.metrics.gastos : 0,
                    Math.abs(showUtilidadBruta ? p.metrics.utilidadBruta : 0),
                    Math.abs(showUtilidadAdmin ? p.metrics.utilidadAdmin : 0)
                );
            })) * 1.1 || 100;
            
            const bars = periodData.map(period => {
                const metrics = [];
                if (showIngreso) metrics.push({ label: 'Ingreso', value: period.metrics.ingreso, color: 'emerald' });
                if (showFlujo) metrics.push({ label: 'Flujo', value: period.metrics.flujo, color: 'cyan' });
                if (showCostoVentas) metrics.push({ label: 'Costo Ventas', value: period.metrics.costoVentas, color: 'blue' });
                if (showGastos) metrics.push({ label: 'Gastos', value: period.metrics.gastos, color: 'orange' });
                if (showUtilidadBruta) metrics.push({ label: 'Util. Bruta', value: period.metrics.utilidadBruta, color: period.metrics.utilidadBruta >= 0 ? 'green' : 'red' });
                if (showUtilidadAdmin) metrics.push({ label: 'Util. Admin', value: period.metrics.utilidadAdmin, color: period.metrics.utilidadAdmin >= 0 ? 'green' : 'red' });
                
                const barsHTML = metrics.map(m => {
                    const height = (Math.abs(m.value) / maxMetric) * 100;
                    const classes = METRIC_COLOR_CLASSES[m.color];
                    return `
                        <div class="flex flex-col items-center">
                            <div class="w-12 ${classes.bg} rounded-t shadow-sm border ${classes.border}" style="height: ${height}%"></div>
                            <p class="text-[8px] text-gray-400 mt-1 text-center">${m.label}</p>
                            <p class="text-[9px] font-bold ${classes.text}">${formatMoney(m.value)}</p>
                        </div>
                    `;
                }).join('');
                
                return `
                    <div class="flex flex-col items-center gap-2">
                        <p class="text-[10px] font-bold text-emerald-400 uppercase tracking-wider">${period.label}</p>
                        <div class="flex items-end gap-2 h-48">${barsHTML}</div>
                    </div>
                `;
            }).join('');
            
            return `
                <div class="relative w-full h-full p-6 flex items-center justify-center gap-8 overflow-x-auto">
                    ${bars}
                </div>
            `;
        }

        function renderRecepcion() {
            const validezFilter = document.getElementById('filter-recepcion-validez')?.value || 'V√°lido';
            const filtered = GLOBAL_DATA.recepciones.filter(r => validezFilter === 'ALL' || r.validez === validezFilter);
            document.getElementById('kpi-recepcion-count').textContent = filtered.length;

            const tbody = document.querySelector('#table-recepcion tbody');
            tbody.innerHTML = filtered.slice(0, 100).map(r => `
                <tr>
                    <td class="text-blue-400 font-bold">${r.folio || '-'}</td>
                    <td>${formatDate(r.fecha)}</td>
                    <td class="text-[10px] uppercase">${r.tipo_sol || '-'}</td>
                    <td class="text-[10px] text-gray-300">${r.marca_modelo}</td>
                    <td class="text-[10px] text-blue-300">${r.tipo_serv || '-'}</td>
                    <td class="font-mono text-right">${formatMoney(r.monto)}</td>
                    <td class="text-center">${r.enciende === 'S√≠' ? 'üü¢' : 'üî¥'}</td>
                    <td class="text-center">${r.mojado === 'S√≠' ? 'üíß' : '-'}</td>
                    <td class="text-yellow-500 font-bold text-[10px]">${r.ant_ref}</td>
                </tr>
            `).join('');
            renderMiniCharts('charts-recepcion-dynamic', ['1Ô∏è‚É£Tipo Solicitud', '‚öôÔ∏èTipo Servicio', '¬ÆÔ∏èMarca', 'üíßMojado'], 'blue');
        }

        function renderAnticipos() {
            const filtered = GLOBAL_DATA.anticipos.filter(a => a.validez === 'V√°lido'); 
            const totalAnt = filtered.reduce((s, a) => s + a.monto, 0);
            const kpiAnt = document.getElementById('kpi-anticipos-total');
            if(kpiAnt) kpiAnt.textContent = formatMoney(totalAnt);

            const tbody = document.querySelector('#table-anticipos tbody');
            tbody.innerHTML = filtered.slice(0, 100).map(a => `
                <tr>
                    <td class="text-yellow-400 font-bold">${a.folio || '-'}</td>
                    <td>${formatDate(a.fecha)}</td>
                    <td class="font-mono text-right font-bold text-white">${formatMoney(a.monto)}</td>
                    <td class="text-blue-400 text-[10px]">${a.ref_rec_display || '-'}</td>
                    <td class="text-gray-400 text-[10px]">${a.dispositivo_ref || '-'}</td>
                    <td class="text-[10px] uppercase tracking-wider ${a.estatus === 'Cerrado' ? 'text-green-500' : 'text-yellow-200'}">${a.estatus || '-'}</td>
                    <td class="text-[10px]">${a.vigencia || '-'}</td>
                </tr>
            `).join('');
            renderMiniCharts('charts-anticipos-dynamic', ['Estatus', 'Vigencia', 'Marca', 'Modelo'], 'yellow');
        }

        function renderEgresos() {
            const tipoFilter = document.getElementById('filter-egresos-tipo')?.value || 'ALL';
            const filtered = GLOBAL_DATA.egresos.filter(e => 
                e.validez === 'V√°lido' && 
                (tipoFilter === 'ALL' || e.tipo === tipoFilter)
            );
            const totalEgr = filtered.reduce((s, e) => s + e.monto, 0);
            const kpiEgr = document.getElementById('kpi-egresos-total');
            if(kpiEgr) kpiEgr.textContent = formatMoney(totalEgr);

            const tbody = document.querySelector('#table-egresos tbody');
            tbody.innerHTML = filtered.slice(0, 100).map(e => `
                <tr>
                    <td class="text-red-400 font-bold">${e.folio}</td>
                    <td>${formatDate(e.fecha)}</td>
                    <td class="uppercase text-[10px] font-bold">${e.tipo}</td>
                    <td class="text-gray-400 text-[10px]">${e.subtipo || '-'}</td>
                    <td class="font-mono text-right text-red-300">${formatMoney(e.monto)}</td>
                    <td class="text-[10px] text-blue-300 truncate max-w-[100px]">${e.proveedor || '-'}</td>
                    <td class="text-[10px] text-gray-500 font-mono">${e.ref_rec || e.ref_ant || ''}</td>
                </tr>
            `).join('');
            renderMiniCharts('charts-egresos-dynamic', ['Tipo', 'Subtipo', 'Proveedor', 'Estatus'], 'red');
        }

        function renderMiniCharts(containerId, labels, color) {
            const container = document.getElementById(containerId);
            if(!container) return;
            container.innerHTML = labels.map(label => `
                <div class="h-32 bg-slate-800/40 border border-${color}-500/20 rounded-lg p-3 flex flex-col justify-between hover:border-${color}-500/50 transition-colors cursor-pointer group">
                    <div class="flex justify-between items-start">
                        <p class="text-[10px] uppercase font-bold text-${color}-400 tracking-wider">${label}</p>
                    </div>
                    <div class="flex items-end gap-1 h-16 opacity-80 mt-2">
                        <div class="w-1/5 bg-gradient-to-t from-${color}-900 to-${color}-500 rounded-t-sm h-full opacity-50"></div>
                        <div class="w-1/5 bg-gradient-to-t from-${color}-900 to-${color}-500 rounded-t-sm h-3/4 opacity-50"></div>
                        <div class="w-1/5 bg-gradient-to-t from-${color}-900 to-${color}-500 rounded-t-sm h-1/2 opacity-50"></div>
                        <div class="w-1/5 bg-gradient-to-t from-${color}-900 to-${color}-500 rounded-t-sm h-1/4 opacity-50"></div>
                    </div>
                </div>
            `).join('');
        }

        // --- INICIALIZACI√ìN ---
        window.updateDashboard = renderAll;
        window.onload = loadAllData; // Iniciar carga al abrir

    </script>

    <script>
        // Funciones UI globales
        function toggleSection(id) {
            const content = document.getElementById('content-' + id);
            const icon = document.getElementById('icon-' + id);
            if(content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                icon.style.transform = 'rotate(-90deg)';
            } else {
                content.classList.add('expanded');
                icon.style.transform = 'rotate(0deg)';
            }
        }
        function expandAll() { document.querySelectorAll('.collapsible-content').forEach(e => e.classList.add('expanded')); }
        function collapseAll() { document.querySelectorAll('.collapsible-content').forEach(e => e.classList.remove('expanded')); }
        function syncFilters(from, to) { alert(`Filtros de ${from} aplicados a ${to}`); }
    </script>
</body>
</html>
